var ye=Object.defineProperty;var _e=(r,e,t)=>e in r?ye(r,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):r[e]=t;var h=(r,e,t)=>_e(r,typeof e!="symbol"?e+"":e,t);const W=class W{constructor(...e){h(this,"min");h(this,"max");if(!e.length){this.min=1/0,this.max=-1/0;return}if(typeof e[0]=="number")this.min=e[0],this.max=e[1];else{const[n,s]=e;this.min=n.min<=s.min?n.min:s.min,this.max=n.max>=s.max?n.max:s.max}}expand(e){const t=e/2;return this.min-=t,this.max+=t,this}clamp(e){return e<this.min?this.min:e>this.max?this.max:e}size(){return this.max-this.min}contains(e){return e>=this.min&&e<=this.max}surrounds(e){return e>this.min&&e<this.max}add_offset(e){return this.min+=e,this.max+=e,this}clone(){return new W(this.min,this.max)}};h(W,"Empty",new W(1/0,-1/0)),h(W,"Universe",new W(-1/0,1/0));let b=W;function O(r,e,t){if(r!==e)throw new Error("not equal!")}function be(r,e,t){return(e-r)*t+r}function Ut(r){return r-Math.floor(r)}function V(r,e){return r==null?Math.random():be(r,e,Math.random())}function ge(r,e){return Math.floor(V(r,e+1))}function le(r,e){return r.clone().addScaledVector(e,-2*r.dot(e))}function we(r,e,t){const n=Math.min(-r.dot(e),1),s=r.clone().addScaledVector(e,n).multiplyScalar(t),o=-Math.sqrt(1-s.lengthSquared());return s.addScaledVector(e,o)}function ve(r,e){let t=(1-e)/(1+e);return t=t*t,t+(1-t)*Math.pow(1-r,5)}function fe(){const r=Math.random()*Math.PI*2,e=Math.random()*2-1,t=Math.sqrt(1-e*e),n=t*Math.cos(r),s=e,o=t*Math.sin(r);return new _(n,s,o)}function Se(){const r=V(),e=V(),t=2*Math.PI*r,n=e**.5;return new _(Math.cos(t)*n,Math.sin(t)*n,(1-e)**.5)}function ze(){const r=Math.random(),e=Math.PI*2*Math.random();return[Math.cos(e)*r,Math.sin(e)*r]}function Zt(r){return r/180*Math.PI}function Dt(r){return Math.sqrt(r)}var P=(r=>(r[r.X=0]="X",r[r.Y=1]="Y",r[r.Z=2]="Z",r))(P||{});async function Oe(r){return new Promise((e,t)=>{fetch(r).then(n=>n.blob()).then(n=>createImageBitmap(n)).then(n=>e(n)).catch(t)})}const B=class B{constructor(e=0,t=0,n=0){this.x=e,this.y=t,this.z=n}getComponent(e){return e===P.X?this.x:e===P.Y?this.y:this.z}set(e,t,n){return this.x=e,this.y=t,this.z=n,this}add(e){return this.x+=e.x,this.y+=e.y,this.z+=e.z,this}addScalar(e){return this.x+=e,this.y+=e,this.z+=e,this}addScaledVector(e,t){return this.x+=e.x*t,this.y+=e.y*t,this.z+=e.z*t,this}sub(e){return this.x-=e.x,this.y-=e.y,this.z-=e.z,this}multiply(e){return this.x*=e.x,this.y*=e.y,this.z*=e.z,this}multiplyScalar(e){return this.x*=e,this.y*=e,this.z*=e,this}divide(e){return this.x/=e.x,this.y/=e.y,this.z/=e.z,this}divideScalar(e){return this.multiplyScalar(1/e)}dot(e){return this.x*e.x+this.y*e.y+this.z*e.z}cross(e){const t=this.x,n=this.y,s=this.z,o=e.x,f=e.y,l=e.z;return this.x=n*l-s*f,this.y=s*o-t*l,this.z=t*f-n*o,this}lengthSquared(){return this.x*this.x+this.y*this.y+this.z*this.z}length(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z)}random(e,t){return this.x=V(e,t),this.y=V(e,t),this.z=V(e,t),this}lerpVectors(e,t,n){return this.x=e.x+(t.x-e.x)*n,this.y=e.y+(t.y-e.y)*n,this.z=e.z+(t.z-e.z)*n,this}normalize(){return this.divideScalar(this.length()||1)}clone(){return new B(this.x,this.y,this.z)}*[Symbol.iterator](){yield this.x,yield this.y,yield this.z}toJSON(){return{type:B.type,x:this.x,y:this.y,z:this.z}}static fromJSON(e){return O(e.type,B.type),new B(e.x,e.y,e.z)}};h(B,"type","_Vector3");let _=B;const G=class G extends _{get r(){return this.x}set r(e){this.x=e}get g(){return this.y}set g(e){this.y=e}get b(){return this.z}set b(e){this.z=e}toJSON(){return{type:G.type,x:this.x,y:this.y,z:this.z}}static fromJSON(e){return O(e.type,G.type),new G(e.x,e.y,e.z)}clone(){return new G(this.x,this.y,this.z)}};h(G,"type","_Color"),h(G,"Red",new G(1,0,0)),h(G,"Black",new G(0,0,0));let w=G;class de{constructor(e){h(this,"axis");const t=e.clone().normalize(),n=Math.abs(t.x)>.9?new _(0,1,0):new _(1,0,0),s=t.clone().cross(n).normalize(),o=t.clone().cross(s);this.axis=[o,s,t]}get u(){return this.axis[0]}get v(){return this.axis[1]}get w(){return this.axis[2]}transform(e){return new _(0,0,0).addScaledVector(this.axis[0],e.x).addScaledVector(this.axis[1],e.y).addScaledVector(this.axis[2],e.z)}}class Gt{}const Xt=class Xt extends Gt{value(e){return Xt._pdf}generate(){return fe()}};h(Xt,"_pdf",1/4/Math.PI);let Ft=Xt;class Ne extends Gt{constructor(t){super();h(this,"uvw");this.uvw=new de(t)}value(t){const n=t.clone().normalize().dot(this.uvw.w);return Math.max(0,n/Math.PI)}generate(){return this.uvw.transform(Se())}}class Je extends Gt{constructor(t,n){super();h(this,"objects");h(this,"origin");this.objects=t,this.origin=n}value(t){return this.objects.pdf_value(this.origin,t)}generate(){return this.objects.random(this.origin)}}class Me extends Gt{constructor(t,n){super();h(this,"p");this.p=[t,n]}value(t){return .5*this.p[0].value(t)+.5*this.p[1].value(t)}generate(){return V()<.5?this.p[0].generate():this.p[1].generate()}}const et=class et{constructor(e,t,n){h(this,"origin");h(this,"dir");h(this,"norm_dir");h(this,"tm");this.origin=e,this.dir=t,this.norm_dir=t.clone().normalize(),this.tm=n}at(e){return this.origin.clone().addScaledVector(this.dir,e)}toJSON(){return{type:et.type,origin:this.origin.toJSON(),dir:this.dir.toJSON(),tm:this.tm}}static fromJSON(e){return O(e.type,et.type),new et(_.fromJSON(e.origin),_.fromJSON(e.dir),e.tm)}};h(et,"type","_Ray");let $=et;function je(r){return r.aspect_ratio=r.aspect_ratio??1,r.image_width=r.image_width??100,r.samples_per_pixel=r.samples_per_pixel??10,r.max_depth=r.max_depth??10,r.background=r.background??new w(.7,.8,1),r.vfov=r.vfov??90,r.lookfrom=r.lookfrom??new _(0,0,0),r.lookat=r.lookat??new _(0,0,-1),r.vup=r.vup??new _(0,1,0),r.defocus_angle=r.defocus_angle??0,r.focus_dist=r.focus_dist??10,r}const nt=class nt{constructor(e){h(this,"aspect_ratio");h(this,"image_width");h(this,"image_height");h(this,"vfov");h(this,"center");h(this,"lookfrom");h(this,"lookat");h(this,"vup");h(this,"focus_dist");h(this,"defocus_angle");h(this,"samples_per_pixel");h(this,"max_depth");h(this,"background");h(this,"pixel_samples_scale");h(this,"sqrt_spp");h(this,"recip_sqrt_spp");h(this,"pixel_delta_u");h(this,"pixel_delta_v");h(this,"pixel00_loc");h(this,"defocus_disk_u");h(this,"defocus_disk_v");const{aspect_ratio:t,image_width:n,samples_per_pixel:s,max_depth:o,vfov:f,lookfrom:l,lookat:i,vup:a,focus_dist:u,defocus_angle:c,background:d}=je(e||{});this.samples_per_pixel=s,this.sqrt_spp=Math.floor(s**.5),this.pixel_samples_scale=1/this.sqrt_spp**2,this.recip_sqrt_spp=1/this.sqrt_spp,this.max_depth=o,this.background=d,this.aspect_ratio=t,this.image_width=n,this.vfov=f;const x=this.image_height=Math.floor(n/t);this.lookfrom=l,this.lookat=i,this.vup=a,this.center=l,this.focus_dist=u,this.defocus_angle=c;const z=2*Math.tan(Zt(f)/2)*u,E=z*n/x,N=l.clone().sub(i).normalize(),X=a.clone().cross(N).normalize(),Q=N.clone().cross(X),m=X.clone().multiplyScalar(E),y=Q.clone().multiplyScalar(-z);this.pixel_delta_u=m.clone().divideScalar(n),this.pixel_delta_v=y.clone().divideScalar(x),this.pixel00_loc=this.center.clone().addScaledVector(N,-u).addScaledVector(m,-.5).addScaledVector(y,-.5).addScaledVector(this.pixel_delta_u,.5).addScaledVector(this.pixel_delta_v,.5);const v=u*Math.tan(Zt(c/2));this.defocus_disk_u=X.clone().multiplyScalar(v),this.defocus_disk_v=Q.clone().multiplyScalar(v)}toJSON(){return{type:nt.type,aspect_ratio:this.aspect_ratio,image_width:this.image_width,samples_per_pixel:this.samples_per_pixel,max_depth:this.max_depth,background:this.background.toJSON(),vfov:this.vfov,lookfrom:this.lookfrom.toJSON(),lookat:this.lookat.toJSON(),vup:this.vup.toJSON(),focus_dist:this.focus_dist,defocus_angle:this.defocus_angle}}static fromJSON(e){return O(e.type,nt.type),new nt({...e,background:w.fromJSON(e.background),lookfrom:_.fromJSON(e.lookfrom),lookat:_.fromJSON(e.lookat),vup:_.fromJSON(e.vup)})}};h(nt,"type","_Camera");let At=nt;function Ht(r,e,t,n,s){if(e<=0)return new w(0,0,0);const o=t.hit(r,new b(.001,1/0));if(!o)return n.background.clone();const f=new w(0,0,0),l=o.mat.emitted(r,o,o.u,o.v,o.p);f.add(l);const i=o.mat.scatter(r,o);if(!i)return f;if(i.skip_pdf)return Ht(i.skip_pdf_ray,e-1,t,n,s).multiply(i.attenuation);const a=new Je(s,o.p),u=new Me(a,i.pdf),c=new $(o.p,u.generate(),r.tm),d=u.value(c.dir),x=o.mat.scattering_pdf(r,o,c),p=Ht(c,e-1,t,n,s).multiply(i.attenuation).multiplyScalar(x/d);return f.add(p),f}function ke(r,e,t,n,s){const{max_depth:o,defocus_angle:f,pixel00_loc:l,pixel_delta_u:i,pixel_delta_v:a,center:u,sqrt_spp:c,recip_sqrt_spp:d,pixel_samples_scale:x,defocus_disk_u:p,defocus_disk_v:z}=r,E=new w(0,0,0);for(let m=0;m<c;m++)for(let y=0;y<c;y++){const v=N(n,s,y,m),g=Ht(v,o,e,r,t);E.addScaledVector(g,x)}return E;function N(m,y,v,g){const S=X(v,g),M=l.clone().addScaledVector(i,m+S.x).addScaledVector(a,y+S.y),j=f<=0?u:Q(),k=M.sub(j),T=Math.random();return new $(j,k,T)}function X(m,y){const v=(m+V())*d-.5,g=(y+V())*d-.5;return new _(v,g,0)}function Q(){const m=ze();return u.clone().addScaledVector(p,m[0]).addScaledVector(z,m[1])}}var qe=typeof global=="object"&&global&&global.Object===Object&&global,Ie=typeof self=="object"&&self&&self.Object===Object&&self,Pe=qe||Ie||Function("return this")(),Nt=Pe.Symbol,xe=Object.prototype,Ve=xe.hasOwnProperty,Ee=xe.toString,_t=Nt?Nt.toStringTag:void 0;function $e(r){var e=Ve.call(r,_t),t=r[_t];try{r[_t]=void 0;var n=!0}catch{}var s=Ee.call(r);return n&&(e?r[_t]=t:delete r[_t]),s}var Ce=Object.prototype,Xe=Ce.toString;function Te(r){return Xe.call(r)}var Ge="[object Null]",Qe="[object Undefined]",se=Nt?Nt.toStringTag:void 0;function Ue(r){return r==null?r===void 0?Qe:Ge:se&&se in Object(r)?$e(r):Te(r)}function De(r){return r!=null&&typeof r=="object"}var Re="[object Symbol]";function Ye(r){return typeof r=="symbol"||De(r)&&Ue(r)==Re}var Ze=/\s/;function Fe(r){for(var e=r.length;e--&&Ze.test(r.charAt(e)););return e}var Ae=/^\s+/;function He(r){return r&&r.slice(0,Fe(r)+1).replace(Ae,"")}function oe(r){var e=typeof r;return r!=null&&(e=="object"||e=="function")}var ae=NaN,We=/^[-+]0x[0-9a-f]+$/i,Be=/^0b[01]+$/i,Le=/^0o[0-7]+$/i,Ke=parseInt;function Rt(r){if(typeof r=="number")return r;if(Ye(r))return ae;if(oe(r)){var e=typeof r.valueOf=="function"?r.valueOf():r;r=oe(e)?e+"":e}if(typeof r!="string")return r===0?r:+r;r=He(r);var t=Be.test(r);return t||Le.test(r)?Ke(r.slice(2),t?2:8):We.test(r)?ae:+r}function tn(r,e,t){return r===r&&(t!==void 0&&(r=r<=t?r:t),e!==void 0&&(r=r>=e?r:e)),r}function Jt(r,e,t){return t===void 0&&(t=e,e=void 0),t!==void 0&&(t=Rt(t),t=t===t?t:0),e!==void 0&&(e=Rt(e),e=e===e?e:0),tn(Rt(r),e,t)}const en=typeof importScripts<"u",Wt=en?new OffscreenCanvas(1,1):document.createElement("canvas"),ce=Wt.getContext("2d");function nn(r){return Wt.width=r.width,Wt.height=r.height,ce.drawImage(r,0,0),ce.getImageData(0,0,r.width,r.height)}class rn{constructor(e){h(this,"src");h(this,"image_width");h(this,"image_height");h(this,"clamp_range");h(this,"bdata");this.src=e}get loaded(){return!!this.bdata}get width(){return this.image_width}get height(){return this.image_height}async load(){const e=await Oe(this.src);this.image_width=e.width,this.image_height=e.height,this.clamp_range=[e.width-1,e.height-1],this.bdata=nn(e)}pixel_data(e,t){if(!this.bdata)return[255,0,255,255];const[n,s]=this.clamp_range;e=Jt(e,0,n),t=Jt(t,0,s);const o=(t*this.image_width+e)*4,f=this.bdata.data;return[f[o],f[o+1],f[o+2],f[o+3]]}}var L=typeof globalThis<"u"?globalThis:typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{};function sn(r){return r&&r.__esModule&&Object.prototype.hasOwnProperty.call(r,"default")?r.default:r}function on(r){if(r.__esModule)return r;var e=r.default;if(typeof e=="function"){var t=function n(){return this instanceof n?Reflect.construct(e,arguments,this.constructor):e.apply(this,arguments)};t.prototype=e.prototype}else t={};return Object.defineProperty(t,"__esModule",{value:!0}),Object.keys(r).forEach(function(n){var s=Object.getOwnPropertyDescriptor(r,n);Object.defineProperty(t,n,s.get?s:{enumerable:!0,get:function(){return r[n]}})}),t}var Lt={exports:{}};Lt.exports;(function(r){(function(e,t,n){function s(i){var a=this,u=l();a.next=function(){var c=2091639*a.s0+a.c*23283064365386963e-26;return a.s0=a.s1,a.s1=a.s2,a.s2=c-(a.c=c|0)},a.c=1,a.s0=u(" "),a.s1=u(" "),a.s2=u(" "),a.s0-=u(i),a.s0<0&&(a.s0+=1),a.s1-=u(i),a.s1<0&&(a.s1+=1),a.s2-=u(i),a.s2<0&&(a.s2+=1),u=null}function o(i,a){return a.c=i.c,a.s0=i.s0,a.s1=i.s1,a.s2=i.s2,a}function f(i,a){var u=new s(i),c=a&&a.state,d=u.next;return d.int32=function(){return u.next()*4294967296|0},d.double=function(){return d()+(d()*2097152|0)*11102230246251565e-32},d.quick=d,c&&(typeof c=="object"&&o(c,u),d.state=function(){return o(u,{})}),d}function l(){var i=4022871197,a=function(u){u=String(u);for(var c=0;c<u.length;c++){i+=u.charCodeAt(c);var d=.02519603282416938*i;i=d>>>0,d-=i,d*=i,i=d>>>0,d-=i,i+=d*4294967296}return(i>>>0)*23283064365386963e-26};return a}t&&t.exports?t.exports=f:this.alea=f})(L,r)})(Lt);var an=Lt.exports,Kt={exports:{}};Kt.exports;(function(r){(function(e,t,n){function s(l){var i=this,a="";i.x=0,i.y=0,i.z=0,i.w=0,i.next=function(){var c=i.x^i.x<<11;return i.x=i.y,i.y=i.z,i.z=i.w,i.w^=i.w>>>19^c^c>>>8},l===(l|0)?i.x=l:a+=l;for(var u=0;u<a.length+64;u++)i.x^=a.charCodeAt(u)|0,i.next()}function o(l,i){return i.x=l.x,i.y=l.y,i.z=l.z,i.w=l.w,i}function f(l,i){var a=new s(l),u=i&&i.state,c=function(){return(a.next()>>>0)/4294967296};return c.double=function(){do var d=a.next()>>>11,x=(a.next()>>>0)/4294967296,p=(d+x)/(1<<21);while(p===0);return p},c.int32=a.next,c.quick=c,u&&(typeof u=="object"&&o(u,a),c.state=function(){return o(a,{})}),c}t&&t.exports?t.exports=f:this.xor128=f})(L,r)})(Kt);var cn=Kt.exports,te={exports:{}};te.exports;(function(r){(function(e,t,n){function s(l){var i=this,a="";i.next=function(){var c=i.x^i.x>>>2;return i.x=i.y,i.y=i.z,i.z=i.w,i.w=i.v,(i.d=i.d+362437|0)+(i.v=i.v^i.v<<4^(c^c<<1))|0},i.x=0,i.y=0,i.z=0,i.w=0,i.v=0,l===(l|0)?i.x=l:a+=l;for(var u=0;u<a.length+64;u++)i.x^=a.charCodeAt(u)|0,u==a.length&&(i.d=i.x<<10^i.x>>>4),i.next()}function o(l,i){return i.x=l.x,i.y=l.y,i.z=l.z,i.w=l.w,i.v=l.v,i.d=l.d,i}function f(l,i){var a=new s(l),u=i&&i.state,c=function(){return(a.next()>>>0)/4294967296};return c.double=function(){do var d=a.next()>>>11,x=(a.next()>>>0)/4294967296,p=(d+x)/(1<<21);while(p===0);return p},c.int32=a.next,c.quick=c,u&&(typeof u=="object"&&o(u,a),c.state=function(){return o(a,{})}),c}t&&t.exports?t.exports=f:this.xorwow=f})(L,r)})(te);var hn=te.exports,ee={exports:{}};ee.exports;(function(r){(function(e,t,n){function s(l){var i=this;i.next=function(){var u=i.x,c=i.i,d,x;return d=u[c],d^=d>>>7,x=d^d<<24,d=u[c+1&7],x^=d^d>>>10,d=u[c+3&7],x^=d^d>>>3,d=u[c+4&7],x^=d^d<<7,d=u[c+7&7],d=d^d<<13,x^=d^d<<9,u[c]=x,i.i=c+1&7,x};function a(u,c){var d,x=[];if(c===(c|0))x[0]=c;else for(c=""+c,d=0;d<c.length;++d)x[d&7]=x[d&7]<<15^c.charCodeAt(d)+x[d+1&7]<<13;for(;x.length<8;)x.push(0);for(d=0;d<8&&x[d]===0;++d);for(d==8?x[7]=-1:x[d],u.x=x,u.i=0,d=256;d>0;--d)u.next()}a(i,l)}function o(l,i){return i.x=l.x.slice(),i.i=l.i,i}function f(l,i){l==null&&(l=+new Date);var a=new s(l),u=i&&i.state,c=function(){return(a.next()>>>0)/4294967296};return c.double=function(){do var d=a.next()>>>11,x=(a.next()>>>0)/4294967296,p=(d+x)/(1<<21);while(p===0);return p},c.int32=a.next,c.quick=c,u&&(u.x&&o(u,a),c.state=function(){return o(a,{})}),c}t&&t.exports?t.exports=f:this.xorshift7=f})(L,r)})(ee);var un=ee.exports,ne={exports:{}};ne.exports;(function(r){(function(e,t,n){function s(l){var i=this;i.next=function(){var u=i.w,c=i.X,d=i.i,x,p;return i.w=u=u+1640531527|0,p=c[d+34&127],x=c[d=d+1&127],p^=p<<13,x^=x<<17,p^=p>>>15,x^=x>>>12,p=c[d]=p^x,i.i=d,p+(u^u>>>16)|0};function a(u,c){var d,x,p,z,E,N=[],X=128;for(c===(c|0)?(x=c,c=null):(c=c+"\0",x=0,X=Math.max(X,c.length)),p=0,z=-32;z<X;++z)c&&(x^=c.charCodeAt((z+32)%c.length)),z===0&&(E=x),x^=x<<10,x^=x>>>15,x^=x<<4,x^=x>>>13,z>=0&&(E=E+1640531527|0,d=N[z&127]^=x+E,p=d==0?p+1:0);for(p>=128&&(N[(c&&c.length||0)&127]=-1),p=127,z=4*128;z>0;--z)x=N[p+34&127],d=N[p=p+1&127],x^=x<<13,d^=d<<17,x^=x>>>15,d^=d>>>12,N[p]=x^d;u.w=E,u.X=N,u.i=p}a(i,l)}function o(l,i){return i.i=l.i,i.w=l.w,i.X=l.X.slice(),i}function f(l,i){l==null&&(l=+new Date);var a=new s(l),u=i&&i.state,c=function(){return(a.next()>>>0)/4294967296};return c.double=function(){do var d=a.next()>>>11,x=(a.next()>>>0)/4294967296,p=(d+x)/(1<<21);while(p===0);return p},c.int32=a.next,c.quick=c,u&&(u.X&&o(u,a),c.state=function(){return o(a,{})}),c}t&&t.exports?t.exports=f:this.xor4096=f})(L,r)})(ne);var ln=ne.exports,re={exports:{}};re.exports;(function(r){(function(e,t,n){function s(l){var i=this,a="";i.next=function(){var c=i.b,d=i.c,x=i.d,p=i.a;return c=c<<25^c>>>7^d,d=d-x|0,x=x<<24^x>>>8^p,p=p-c|0,i.b=c=c<<20^c>>>12^d,i.c=d=d-x|0,i.d=x<<16^d>>>16^p,i.a=p-c|0},i.a=0,i.b=0,i.c=-1640531527,i.d=1367130551,l===Math.floor(l)?(i.a=l/4294967296|0,i.b=l|0):a+=l;for(var u=0;u<a.length+20;u++)i.b^=a.charCodeAt(u)|0,i.next()}function o(l,i){return i.a=l.a,i.b=l.b,i.c=l.c,i.d=l.d,i}function f(l,i){var a=new s(l),u=i&&i.state,c=function(){return(a.next()>>>0)/4294967296};return c.double=function(){do var d=a.next()>>>11,x=(a.next()>>>0)/4294967296,p=(d+x)/(1<<21);while(p===0);return p},c.int32=a.next,c.quick=c,u&&(typeof u=="object"&&o(u,a),c.state=function(){return o(a,{})}),c}t&&t.exports?t.exports=f:this.tychei=f})(L,r)})(re);var fn=re.exports,pe={exports:{}},dn={},xn=Object.freeze({__proto__:null,default:dn}),pn=on(xn);(function(r){(function(e,t,n){var s=256,o=6,f=52,l="random",i=n.pow(s,o),a=n.pow(2,f),u=a*2,c=s-1,d;function x(m,y,v){var g=[];y=y==!0?{entropy:!0}:y||{};var S=N(E(y.entropy?[m,Q(t)]:m??X(),3),g),M=new p(g),j=function(){for(var k=M.g(o),T=i,U=0;k<a;)k=(k+U)*s,T*=s,U=M.g(1);for(;k>=u;)k/=2,T/=2,U>>>=1;return(k+U)/T};return j.int32=function(){return M.g(4)|0},j.quick=function(){return M.g(4)/4294967296},j.double=j,N(Q(M.S),t),(y.pass||v||function(k,T,U,Y){return Y&&(Y.S&&z(Y,M),k.state=function(){return z(M,{})}),U?(n[l]=k,T):k})(j,S,"global"in y?y.global:this==n,y.state)}function p(m){var y,v=m.length,g=this,S=0,M=g.i=g.j=0,j=g.S=[];for(v||(m=[v++]);S<s;)j[S]=S++;for(S=0;S<s;S++)j[S]=j[M=c&M+m[S%v]+(y=j[S])],j[M]=y;(g.g=function(k){for(var T,U=0,Y=g.i,zt=g.j,yt=g.S;k--;)T=yt[Y=c&Y+1],U=U*s+yt[c&(yt[Y]=yt[zt=c&zt+T])+(yt[zt]=T)];return g.i=Y,g.j=zt,U})(s)}function z(m,y){return y.i=m.i,y.j=m.j,y.S=m.S.slice(),y}function E(m,y){var v=[],g=typeof m,S;if(y&&g=="object")for(S in m)try{v.push(E(m[S],y-1))}catch{}return v.length?v:g=="string"?m:m+"\0"}function N(m,y){for(var v=m+"",g,S=0;S<v.length;)y[c&S]=c&(g^=y[c&S]*19)+v.charCodeAt(S++);return Q(y)}function X(){try{var m;return d&&(m=d.randomBytes)?m=m(s):(m=new Uint8Array(s),(e.crypto||e.msCrypto).getRandomValues(m)),Q(m)}catch{var y=e.navigator,v=y&&y.plugins;return[+new Date,e,v,e.screen,Q(t)]}}function Q(m){return String.fromCharCode.apply(0,m)}if(N(n.random(),t),r.exports){r.exports=x;try{d=pn}catch{}}else n["seed"+l]=x})(typeof self<"u"?self:L,[],Math)})(pe);var mn=pe.exports,yn=an,_n=cn,bn=hn,gn=un,wn=ln,vn=fn,K=mn;K.alea=yn;K.xor128=_n;K.xorwow=bn;K.xorshift7=gn;K.xor4096=wn;K.tychei=vn;var Sn=K,zn=sn(Sn);const q=class q{constructor(e){h(this,"seed");h(this,"prng");h(this,"randvec");h(this,"perm_x");h(this,"perm_y");h(this,"perm_z");this.seed=e,this.prng=zn(e),this.randvec=[];for(let t=0;t<q.point_count;t++)this.randvec[t]=new _(this.random(-1,1),this.random(-1,1),this.random(-1,1)).normalize();this.perm_x=this.perlin_generate_perm(),this.perm_y=this.perlin_generate_perm(),this.perm_z=this.perlin_generate_perm()}noise(e){const t=Ut(e.x),n=Ut(e.y),s=Ut(e.z),o=Math.floor(e.x),f=Math.floor(e.y),l=Math.floor(e.z),i=[[[],[]],[[],[]]];for(let a=0;a<2;a++)for(let u=0;u<2;u++)for(let c=0;c<2;c++)i[a][u][c]=this.randvec[this.perm_x[o+a&255]^this.perm_y[f+u&255]^this.perm_z[l+c&255]];return q.trilinear_interp(i,t,n,s)}turb(e,t){let n=0;const s=e.clone();let o=1;for(let f=0;f<t;f++)n+=o*this.noise(s),o*=.5,s.multiplyScalar(2);return Math.abs(n)}static hermite_cubic_interp(e){return e*e*(3-2*e)}static trilinear_interp(e,t,n,s){const o=q.hermite_cubic_interp(t),f=q.hermite_cubic_interp(n),l=q.hermite_cubic_interp(s);let i=0;const a=new _;for(let u=0;u<2;u++)for(let c=0;c<2;c++)for(let d=0;d<2;d++)a.set(t-u,n-c,s-d),i+=(u*o+(1-u)*(1-o))*(c*f+(1-c)*(1-f))*(d*l+(1-d)*(1-l))*a.dot(e[u][c][d]);return i}toJSON(){return{type:q.type,seed:this.seed}}static fromJSON(e){return O(e.type,q.type),new q(e.seed)}random(e=0,t=1){return(t-e)*this.prng()+e}random_int(e,t){return Math.floor(this.random(e,t+1))}perlin_generate_perm(){const e=[];for(let t=0;t<q.point_count;t++)e[t]=t;return this.permute(e,q.point_count),e}permute(e,t){for(let n=t-1;n>0;n--){const s=this.random_int(0,n),o=e[n];e[n]=e[s],e[s]=o}}};h(q,"type","_Perlin"),h(q,"point_count",256);let Bt=q;const rt=class rt{constructor(...e){h(this,"albedo");typeof e[0]=="number"?this.albedo=new w(e[0],e[1],e[2]):this.albedo=e[0]}value(e,t,n){return this.albedo}toJSON(){return{type:rt.type,albedo:this.albedo.toJSON()}}static fromJSON(e){return O(e.type,rt.type),new rt(w.fromJSON(e.albedo))}};h(rt,"type","_SolidColorTexture");let D=rt;const it=class it{constructor(...e){h(this,"even");h(this,"odd");h(this,"inv_scale");e[1]instanceof w?(this.inv_scale=1/e[0],this.even=new D(e[1]),this.odd=new D(e[2])):(this.inv_scale=1/e[0],this.even=e[1],this.odd=e[2])}value(e,t,n){const s=Math.floor(this.inv_scale*n.x),o=Math.floor(this.inv_scale*n.y),f=Math.floor(this.inv_scale*n.z);return(s+o+f)%2===0?this.even.value(e,t,n):this.odd.value(e,t,n)}toJSON(){return{type:it.type,scale:1/this.inv_scale,even:this.even.toJSON(),odd:this.odd.toJSON()}}static fromJSON(e){return O(e.type,it.type),new it(e.scale,pt(e.even),pt(e.odd))}};h(it,"type","_CheckerTexture");let Mt=it;const st=class st{constructor(e){h(this,"image");h(this,"src");this.src=e,this.image=new rn(e)}load(){return this.image.load()}value(e,t,n){if(!this.image.loaded)return new w(0,1,1);e=Jt(e,0,1),t=1-Jt(t,0,1);const s=Math.floor(e*this.image.width),o=Math.floor(t*this.image.height),f=this.image.pixel_data(s,o);return new w(f[0]/255,f[1]/255,f[2]/255)}toJSON(){return{type:st.type,src:this.src}}static fromJSON(e){return O(e.type,st.type),new st(e.src)}};h(st,"type","_ImageTexture");let bt=st;const ot=class ot{constructor(e){h(this,"noise");h(this,"scale");this.scale=e,this.noise=new Bt("perlin-noise-seed")}value(e,t,n){return new w(1,1,1).multiplyScalar(.5).multiplyScalar(1+Math.sin(this.scale*n.z+10*this.noise.turb(n,7)))}toJSON(){return{type:ot.type,noise:this.noise.toJSON(),scale:this.scale}}static fromJSON(e){return O(e.type,ot.type),new ot(e.scale)}};h(ot,"type","_NoiseTexture");let jt=ot;function pt(r){switch(r.type){case w.type:return new D(w.fromJSON(r));case D.type:return D.fromJSON(r);case Mt.type:return Mt.fromJSON(r);case bt.type:return bt.fromJSON(r);case jt.type:return jt.fromJSON(r);default:throw new Error("无效的texture类型:"+r.type)}}const J=class J{constructor(...e){h(this,"x");h(this,"y");h(this,"z");if(!e.length){this.x=new b,this.y=new b,this.z=new b;return}const t=e[0];if(t instanceof b){const[n,s,o]=e;this.x=n,this.y=s,this.z=o}else if(t instanceof _){const[n,s]=e;this.x=n.x<s.x?new b(n.x,s.x):new b(s.x,n.x),this.y=n.y<s.y?new b(n.y,s.y):new b(s.y,n.y),this.z=n.z<s.z?new b(n.z,s.z):new b(s.z,n.z)}else if(t instanceof J){const[n,s]=e;this.x=new b(n.x,s.x),this.y=new b(n.y,s.y),this.z=new b(n.z,s.z)}this.pad_to_minimums()}pad_to_minimums(){this.x.size()<J.delta&&this.x.expand(J.delta),this.y.size()<J.delta&&this.y.expand(J.delta),this.z.size()<J.delta&&this.z.expand(J.delta)}get_axis_interval(e){return e===P.Y?this.y:e===P.Z?this.z:this.x}hit(e,t){const{origin:n,dir:s}=e,o=t.clone();for(let f=0;f<3;f++){const l=this.get_axis_interval(f),i=1/s.getComponent(f),a=(l.min-n.getComponent(f))*i,u=(l.max-n.getComponent(f))*i;if(a<u?(a>o.min&&(o.min=a),u<o.max&&(o.max=u)):(u>o.min&&(o.min=u),a<o.max&&(o.max=a)),o.max<=o.min)return!1}return!0}longest_axis(){const e=this.x.size(),t=this.y.size(),n=this.z.size();return e>t?e>n?P.X:P.Z:t>n?P.Y:P.Z}add_offset(e){return this.x.add_offset(e.x),this.y.add_offset(e.y),this.z.add_offset(e.z),this}clone(){return new J(this.x.clone(),this.y.clone(),this.z.clone())}};h(J,"Empty",new J(b.Empty,b.Empty,b.Empty)),h(J,"Universe",new J(b.Universe,b.Universe,b.Universe)),h(J,"delta",1e-4);let C=J;class Qt{constructor(){h(this,"attenuation");h(this,"pdf");h(this,"skip_pdf");h(this,"skip_pdf_ray")}}class ie{constructor(){h(this,"p");h(this,"normal");h(this,"t");h(this,"front_face");h(this,"mat");h(this,"u");h(this,"v")}set_face_normal(e,t){this.front_face=e.dir.dot(t)<0,this.normal=this.front_face?t:t.clone().multiplyScalar(-1)}}class tt{pdf_value(e,t){return 0}random(e){return new _(1,0,0)}}const at=class at extends tt{constructor(t,n){super();h(this,"offset");h(this,"object");h(this,"bbox");this.object=t,this.offset=n,this.bbox=t.bounding_box().clone().add_offset(n)}bounding_box(){return this.bbox}hit(t,n){const s=new $(t.origin.clone().sub(this.offset),t.dir,t.tm),o=this.object.hit(s,n);return o?(o.p.add(this.offset),o):!1}toJSON(){return{type:at.type,offset:this.offset.toJSON(),object:this.object.toJSON()}}static fromJSON(t){return O(at.type,t.type),new at(St(t.object),_.fromJSON(t.offset))}};h(at,"type","_Translate");let kt=at;const ct=class ct extends tt{constructor(t,n){super();h(this,"sin_theta");h(this,"cos_theta");h(this,"bbox");h(this,"object");h(this,"angle");this.angle=n,this.object=t;const s=Zt(n);this.sin_theta=Math.sin(s),this.cos_theta=Math.cos(s);const o=t.bounding_box(),f=new _(1/0,1/0,1/0),l=new _(-1/0,-1/0,-1/0);for(let i=0;i<2;i++)for(let a=0;a<2;a++)for(let u=0;u<2;u++){const c=i*o.x.max+(1-i)*o.x.min,d=a*o.y.max+(1-a)*o.y.min,x=u*o.z.max+(1-u)*o.z.min,p=this.cos_theta*c+this.sin_theta*x,z=-this.sin_theta*c+this.cos_theta*x;f.x=Math.min(f.x,p),f.y=Math.min(f.y,d),f.z=Math.min(f.z,z),l.x=Math.max(l.x,p),l.y=Math.max(l.y,d),l.z=Math.max(l.z,z)}this.bbox=new C(f,l)}bounding_box(){return this.bbox}hit(t,n){const{cos_theta:s,sin_theta:o}=this,f=new _(s*t.origin.x-o*t.origin.z,t.origin.y,o*t.origin.x+s*t.origin.z),l=new _(s*t.dir.x-o*t.dir.z,t.dir.y,o*t.dir.x+s*t.dir.z),i=new $(f,l,t.tm),a=this.object.hit(i,n);return a?(a.p=new _(s*a.p.x+o*a.p.z,a.p.y,-o*a.p.x+s*a.p.z),a.normal=new _(s*a.normal.x+o*a.normal.z,a.normal.y,-o*a.normal.x+s*a.normal.z),a):!1}toJSON(){return{type:ct.type,object:this.object.toJSON(),angle:this.angle}}static fromJSON(t){return O(t.type,ct.type),new ct(St(t.object),t.angle)}};h(ct,"type","_Rotate_Y");let qt=ct;const ht=class ht extends tt{constructor(t){super();h(this,"objects");h(this,"bbox");this.objects=[],this.bbox=new C,this.add(t)}pdf_value(t,n){1/this.objects.length;let s=0;for(let o of this.objects)s+=o.pdf_value(t,n);return s}random(t){const n=ge(0,this.objects.length-1);return this.objects[n].random(t)}bounding_box(){return this.bbox}add(t){return t?(this.objects.push(t),this.bbox=new C(this.bbox,t.bounding_box()),this):this}hit(t,n){let s=!1,o=n.max;for(let f of this.objects){const l=f.hit(t,new b(n.min,o));l&&(o=l.t,s=l)}return s}toJSON(){return{type:ht.type,objects:this.objects.map(t=>t.toJSON())}}static fromJSON(t){O(t.type,ht.type);const n=new ht;return t.objects.forEach(s=>{n.add(St(s))}),n}};h(ht,"type","_HittableList");let mt=ht;const ut=class ut extends tt{constructor(t,n,s,o){super();h(this,"Q");h(this,"u");h(this,"v");h(this,"area");h(this,"material");h(this,"bbox");h(this,"normal");h(this,"D");h(this,"w");this.Q=t,this.u=n,this.v=s,this.material=o;const f=n.clone().cross(s);this.area=f.length(),this.normal=f.clone().normalize(),this.D=this.normal.dot(t),this.w=f.clone().divideScalar(f.dot(f)),this.update_bbox()}update_bbox(){const t=new C(this.Q,this.Q.clone().add(this.u).add(this.v)),n=new C(this.Q.clone().add(this.u),this.Q.clone().add(this.v));this.bbox=new C(t,n)}bounding_box(){return this.bbox}pdf_value(t,n){const s=this.hit(new $(t,n,0),new b(.001,1/0));if(!s)return 0;const o=s.t*s.t*n.lengthSquared(),f=Math.abs(n.dot(s.normal)/n.length());return o/(f*this.area)}random(t){return this.Q.clone().addScaledVector(this.u,V()).addScaledVector(this.v,V()).sub(t)}hit(t,n){const s=this.normal.dot(t.dir);if(Math.abs(s)<1e-8)return!1;const o=(this.D-this.normal.dot(t.origin))/s;if(!n.contains(o))return!1;const f=t.at(o),l=f.clone().sub(this.Q),i=this.w.dot(l.clone().cross(this.v)),a=this.w.dot(this.u.clone().cross(l));if(i<0||i>1||a<0||a>1)return!1;const u=new ie;return u.p=f,u.t=o,u.mat=this.material,u.u=i,u.v=a,u.set_face_normal(t,this.normal),u}toJSON(){return{type:ut.type,Q:this.Q.toJSON(),u:this.u.toJSON(),v:this.v.toJSON(),material:this.material.toJSON()}}static fromJSON(t){return O(t.type,ut.type),new ut(_.fromJSON(t.Q),_.fromJSON(t.u),_.fromJSON(t.v),me(t.material))}};h(ut,"type","_Quad");let It=ut;const Z=class Z extends tt{constructor(...t){super();h(this,"bbox");h(this,"center");h(this,"radius");h(this,"material");if(t.length!==0){if(typeof t[1]=="number"){const[n,s,o]=t;this.center=new $(n,new _(0,0,0),0),this.radius=s,this.material=o}else{const[n,s,o,f]=t;this.center=new $(n,s.clone().sub(n),0),this.radius=o,this.material=f}this.update_bbox()}}static get_sphere_uv(t){const{x:n,y:s,z:o}=t,f=Math.acos(-s);return[(Math.atan2(-o,n)+Math.PI)/(2*Math.PI),f/Math.PI]}update_bbox(){const{center:t,radius:n}=this,s=new _(n,n,n),o=new C(t.at(0).sub(s),t.at(0).add(s)),f=new C(t.at(1).sub(s),t.at(1).add(s));this.bbox=new C(o,f)}bounding_box(){return this.bbox}pdf_value(t,n){if(!this.hit(new $(t,n,0),new b(1e-4,1/0)))return 0;const o=this.center.at(0).sub(t).lengthSquared(),f=(1-this.radius*this.radius/o)**.5;return 1/(2*Math.PI*(1-f))}random(t){const n=this.center.at(0).sub(t),s=n.lengthSquared();return new de(n).transform(Z.random_to_sphere(this.radius,s))}hit(t,n){const s=this.center.at(t.tm),o=s.clone().sub(t.origin),f=t.dir.lengthSquared(),l=t.dir.dot(o),i=o.lengthSquared()-this.radius*this.radius,a=l*l-f*i;if(a<0)return!1;const u=a**.5;let c=(l-u)/f;if(!n.surrounds(c)&&(c=(l+u)/f,!n.surrounds(c)))return!1;const d=new ie;d.t=c,d.p=t.at(d.t),d.mat=this.material;const x=d.p.clone().sub(s).divideScalar(this.radius);d.set_face_normal(t,x);const p=Z.get_sphere_uv(x);return d.u=p[0],d.v=p[1],d}static random_to_sphere(t,n){const s=V(),o=V(),f=(1-t*t/n)**.5,l=1+o*(f-1),i=2*Math.PI*s,a=(1-l**2)**.5;return new _(Math.cos(i)*a,Math.sin(i)*a,l)}toJSON(){return{type:Z.type,center:this.center.toJSON(),radius:this.radius,material:this.material.toJSON()}}static fromJSON(t){O(t.type,Z.type);const n=new Z;return n.center=$.fromJSON(t.center),n.radius=t.radius,n.material=me(t.material),n.update_bbox(),n}};h(Z,"type","_Sphere");let Pt=Z;const lt=class lt extends tt{constructor(t,n,s){super();h(this,"_density");h(this,"_tex_or_albedo");h(this,"boundary");h(this,"neg_inv_density");h(this,"phase_function");this._density=n,this._tex_or_albedo=s,this.boundary=t,this.neg_inv_density=-1/n,this.phase_function=new vt(s)}hit(t,n){const s=this.boundary.hit(t,b.Universe);if(!s)return!1;const o=this.boundary.hit(t,new b(s.t+1e-4,1/0));if(!o||(s.t<n.min&&(s.t=n.min),o.t>n.max&&(o.t=n.max),s.t>o.t))return!1;s.t<0&&(s.t=0);const f=t.dir.length(),l=(o.t-s.t)*f,i=this.neg_inv_density*Math.log(V());if(i>l)return!1;const a=new ie;return a.t=s.t+i/f,a.p=t.at(a.t),a.normal=new _(1,0,0),a.front_face=!0,a.mat=this.phase_function,a}bounding_box(){return this.boundary.bounding_box()}toJSON(){return{type:lt.type,boundary:this.boundary.toJSON(),density:this._density,tex_or_albedo:this._tex_or_albedo.toJSON()}}static fromJSON(t){return O(t.type,lt.type),new lt(St(t.boundary),t.density,t.tex_or_albedo.type===w.type?w.fromJSON(t.tex_or_albedo):pt(t.tex_or_albedo))}};h(lt,"type","_ConstantMedium");let Vt=lt;const I=class I extends tt{constructor(t){super();h(this,"objects");h(this,"left");h(this,"right");h(this,"bbox");this.objects=t,this.bbox=t.reduce((f,l)=>(f=new C(f,l.bounding_box()),f),C.Empty);const n=this.bbox.longest_axis(),s=n===P.X?I.box_x_compare:n===P.Y?I.box_y_compare:I.box_z_compare,o=t.length;if(o===1)this.left=this.right=t[0];else if(o===2)this.left=t[0],this.right=t[1];else{t.sort(s);const f=Math.floor(o/2);this.left=new I(t.slice(0,f)),this.right=new I(t.slice(f))}}hit(t,n){if(!this.bbox.hit(t,n))return!1;const s=this.left.hit(t,n);return this.right.hit(t,new b(n.min,s?s.t:n.max))||s}bounding_box(){return this.bbox}toJSON(){return{type:I.type,objects:this.objects.map(t=>t.toJSON())}}static fromJSON(t){return O(t.type,I.type),new I(t.objects.map(n=>St(n)))}static box_compare(t,n,s){const o=t.bounding_box().get_axis_interval(s),f=n.bounding_box().get_axis_interval(s);return o.min-f.min}static box_x_compare(t,n){return I.box_compare(t,n,P.X)}static box_y_compare(t,n){return I.box_compare(t,n,P.Y)}static box_z_compare(t,n){return I.box_compare(t,n,P.Z)}};h(I,"type","_BvhNode");let gt=I;function St(r){switch(r.type){case gt.type:return gt.fromJSON(r);case Pt.type:return Pt.fromJSON(r);case It.type:return It.fromJSON(r);case kt.type:return kt.fromJSON(r);case qt.type:return qt.fromJSON(r);case mt.type:return mt.fromJSON(r);case Vt.type:return Vt.fromJSON(r);default:throw new Error("无效的object类型:"+r.type)}}const Tt=class Tt{toJSON(){return{type:Tt.type}}scatter(e,t){return!1}scattering_pdf(e,t,n){return 0}emitted(e,t,n,s,o){return new w(0,0,0)}};h(Tt,"type","_Material");let R=Tt;const ft=class ft extends R{constructor(t){super();h(this,"tex");t instanceof w?this.tex=new D(t):this.tex=t}load(){return this.tex instanceof bt?this.tex.load():Promise.resolve()}scattering_pdf(t,n,s){const o=n.normal.dot(s.norm_dir);return o<0?0:o/Math.PI}scatter(t,n){const s=new Qt;return s.attenuation=this.tex.value(n.u,n.v,n.p),s.pdf=new Ne(n.normal),s.skip_pdf=!1,s}toJSON(){return{type:ft.type,tex:this.tex.toJSON()}}static fromJSON(t){return O(t.type,ft.type),new ft(pt(t.tex))}};h(ft,"type","_LambertianMaterial");let wt=ft;const dt=class dt extends R{constructor(e,t){super(),this.albedo=e,this.fuzz=t}scatter(e,t){const n=le(e.dir,t.normal).normalize().addScaledVector(fe(),this.fuzz),s=new Qt;return s.attenuation=this.albedo,s.pdf=null,s.skip_pdf=!0,s.skip_pdf_ray=new $(t.p,n,e.tm),s}toJSON(){return{type:dt.type,albedo:this.albedo.toJSON(),fuzz:this.fuzz}}static fromJSON(e){return O(e.type,dt.type),new dt(w.fromJSON(e.albedo),e.fuzz)}};h(dt,"type","_MetalMaterial");let Et=dt;const F=class F extends R{constructor(e){super(),this.refraction_index=e}scatter(e,t){const n=t.front_face?1/this.refraction_index:this.refraction_index,s=Math.min(-e.norm_dir.dot(t.normal),1),l=Math.sqrt(1-s*s)*n>1||ve(s,n)>Math.random()?le(e.norm_dir,t.normal):we(e.norm_dir,t.normal,n),i=new Qt;return i.attenuation=F.Attenuation,i.pdf=null,i.skip_pdf=!0,i.skip_pdf_ray=new $(t.p,l,e.tm),i}toJSON(){return{type:F.type,refraction_index:this.refraction_index}}static fromJSON(e){return O(e.type,F.type),new F(e.refraction_index)}};h(F,"type","_DielectricMaterial"),h(F,"Attenuation",new w(1,1,1));let $t=F;const xt=class xt extends R{constructor(t){super();h(this,"tex");t instanceof w?this.tex=new D(t):this.tex=t}emitted(t,n,s,o,f){return n.front_face?this.tex.value(s,o,f):new w(0,0,0)}toJSON(){return{type:xt.type,tex:this.tex.toJSON()}}static fromJSON(t){return O(t.type,xt.type),new xt(pt(t.tex))}};h(xt,"type","_DiffuseLightMaterial");let Ct=xt;const A=class A extends R{constructor(t){super();h(this,"tex");t instanceof w?this.tex=new D(t):this.tex=t}scattering_pdf(t,n,s){return A._pdf}scatter(t,n){const s=new Qt;return s.attenuation=this.tex.value(n.u,n.v,n.p),s.pdf=new Ft,s.skip_pdf=!1,s}toJSON(){return{type:A.type,tex:this.tex.toJSON()}}static fromJSON(t){return O(t.type,A.type),new A(pt(t.tex))}};h(A,"type","_IsotropicMaterial"),h(A,"_pdf",1/4/Math.PI);let vt=A;function me(r){switch(r.type){case R.type:return new R;case wt.type:return wt.fromJSON(r);case Et.type:return Et.fromJSON(r);case $t.type:return $t.fromJSON(r);case Ct.type:return Ct.fromJSON(r);case vt.type:return vt.fromJSON(r);default:throw new Error("错误的material类型:"+r.type)}}var H=(r=>(r[r.构建场景=1]="构建场景",r[r.回复构建场景=2]="回复构建场景",r[r.渲染像素=3]="渲染像素",r[r.回复渲染像素=4]="回复渲染像素",r))(H||{});let Yt,he,Ot,ue;self.onmessage=r=>{const e=r.data,t=e.taskId;if(e.type===H.构建场景)try{Yt=mt.fromJSON(e.data.world),he=new gt(Yt.objects),Ot=At.fromJSON(e.data.camera),ue=mt.fromJSON(e.data.lights),Promise.all(On(Yt)).then(()=>{self.postMessage({taskId:t,type:H.回复构建场景,success:!0})}).catch(n=>{throw n})}catch(n){self.postMessage({taskId:t,type:H.回复构建场景,success:!1,error:n})}else if(e.type===H.渲染像素)try{const[n,s]=e.data,o=s-n,f=new Uint8ClampedArray(o*4);for(let l=n;l<s;l++){const i=Math.floor(l/Ot.image_width),a=l-i*Ot.image_width,u=ke(Ot,he,ue,a,i),c=(l-n)*4;u.r=isNaN(u.r)?0:u.r,u.g=isNaN(u.g)?0:u.g,u.b=isNaN(u.b)?0:u.b,f[c]=Math.floor(Dt(u.r)*255),f[c+1]=Math.floor(Dt(u.g)*255),f[c+2]=Math.floor(Dt(u.b)*255),f[c+3]=255}self.postMessage({taskId:t,type:H.回复渲染像素,data:f,success:!0},[f.buffer])}catch(n){self.postMessage({taskId:t,type:H.回复渲染像素,data:null,success:!1,error:n})}};function On(r){return r.objects.map(e=>{if("material"in e){const t=e.material;return t instanceof wt?t.load():null}})}
