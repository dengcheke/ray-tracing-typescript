var pe=Object.defineProperty;var ye=(n,e,t)=>e in n?pe(n,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):n[e]=t;var c=(n,e,t)=>ye(n,typeof e!="symbol"?e+"":e,t);(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))r(i);new MutationObserver(i=>{for(const o of i)if(o.type==="childList")for(const l of o.addedNodes)l.tagName==="LINK"&&l.rel==="modulepreload"&&r(l)}).observe(document,{childList:!0,subtree:!0});function t(i){const o={};return i.integrity&&(o.integrity=i.integrity),i.referrerPolicy&&(o.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?o.credentials="include":i.crossOrigin==="anonymous"?o.credentials="omit":o.credentials="same-origin",o}function r(i){if(i.ep)return;i.ep=!0;const o=t(i);fetch(i.href,o)}})();var Ft=(n=>(n[n.构建场景=1]="构建场景",n[n.回复构建场景=2]="回复构建场景",n[n.渲染像素=3]="渲染像素",n[n.回复渲染像素=4]="回复渲染像素",n))(Ft||{});const re=(()=>{let n=1;return()=>n++})();function we(n,e){const t=new Map;return n.onmessage=r=>{const i=r.data,o=t.get(i.taskId);o&&(i.success?o.resolve(i.data):o.reject(i.error))},{id:e,buildScene(r,i,o){const l=re(),{resolve:h,reject:s,promise:a}=Promise.withResolvers();return n.postMessage({taskId:l,type:Ft.构建场景,data:{world:r,camera:i,lights:o}}),t.set(l,{resolve:h,reject:s}),a},renderPixels(r){const i=re(),{resolve:o,reject:l,promise:h}=Promise.withResolvers();return n.postMessage({taskId:i,type:Ft.渲染像素,data:r}),t.set(i,{resolve:o,reject:l}),h},close(){t.clear(),n.terminate()}}}const H=class H{constructor(...e){c(this,"min");c(this,"max");if(!e.length){this.min=1/0,this.max=-1/0;return}if(typeof e[0]=="number")this.min=e[0],this.max=e[1];else{const[r,i]=e;this.min=r.min<=i.min?r.min:i.min,this.max=r.max>=i.max?r.max:i.max}}expand(e){const t=e/2;return this.min-=t,this.max+=t,this}clamp(e){return e<this.min?this.min:e>this.max?this.max:e}size(){return this.max-this.min}contains(e){return e>=this.min&&e<=this.max}surrounds(e){return e>this.min&&e<this.max}add_offset(e){return this.min+=e,this.max+=e,this}clone(){return new H(this.min,this.max)}};c(H,"Empty",new H(1/0,-1/0)),c(H,"Universe",new H(-1/0,1/0));let _=H;function z(n,e,t){if(n!==e)throw new Error("not equal!")}function ge(n,e,t){return(e-n)*t+n}function Qt(n){return n-Math.floor(n)}function X(n,e){return n==null?Math.random():ge(n,e,Math.random())}function be(n,e){return Math.floor(X(n,e+1))}function ue(n,e){return n.clone().addScaledVector(e,-2*n.dot(e))}function _e(n,e,t){const r=Math.min(-n.dot(e),1),i=n.clone().addScaledVector(e,r).multiplyScalar(t),o=-Math.sqrt(1-i.lengthSquared());return i.addScaledVector(e,o)}function ve(n,e){let t=(1-e)/(1+e);return t=t*t,t+(1-t)*Math.pow(1-n,5)}function he(){const n=Math.random()*Math.PI*2,e=Math.random()*2-1,t=Math.sqrt(1-e*e),r=t*Math.cos(n),i=e,o=t*Math.sin(n);return new m(r,i,o)}function Se(){const n=X(),e=X(),t=2*Math.PI*n,r=e**.5;return new m(Math.cos(t)*r,Math.sin(t)*r,(1-e)**.5)}function Gt(n){return n/180*Math.PI}var I=(n=>(n[n.X=0]="X",n[n.Y=1]="Y",n[n.Z=2]="Z",n))(I||{});async function ze(n){return new Promise((e,t)=>{fetch(n).then(r=>r.blob()).then(r=>createImageBitmap(r)).then(r=>e(r)).catch(t)})}const A=class A{constructor(e=0,t=0,r=0){this.x=e,this.y=t,this.z=r}getComponent(e){return e===I.X?this.x:e===I.Y?this.y:this.z}set(e,t,r){return this.x=e,this.y=t,this.z=r,this}add(e){return this.x+=e.x,this.y+=e.y,this.z+=e.z,this}addScalar(e){return this.x+=e,this.y+=e,this.z+=e,this}addScaledVector(e,t){return this.x+=e.x*t,this.y+=e.y*t,this.z+=e.z*t,this}sub(e){return this.x-=e.x,this.y-=e.y,this.z-=e.z,this}multiply(e){return this.x*=e.x,this.y*=e.y,this.z*=e.z,this}multiplyScalar(e){return this.x*=e,this.y*=e,this.z*=e,this}divide(e){return this.x/=e.x,this.y/=e.y,this.z/=e.z,this}divideScalar(e){return this.multiplyScalar(1/e)}dot(e){return this.x*e.x+this.y*e.y+this.z*e.z}cross(e){const t=this.x,r=this.y,i=this.z,o=e.x,l=e.y,h=e.z;return this.x=r*h-i*l,this.y=i*o-t*h,this.z=t*l-r*o,this}lengthSquared(){return this.x*this.x+this.y*this.y+this.z*this.z}length(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z)}random(e,t){return this.x=X(e,t),this.y=X(e,t),this.z=X(e,t),this}lerpVectors(e,t,r){return this.x=e.x+(t.x-e.x)*r,this.y=e.y+(t.y-e.y)*r,this.z=e.z+(t.z-e.z)*r,this}normalize(){return this.divideScalar(this.length()||1)}clone(){return new A(this.x,this.y,this.z)}*[Symbol.iterator](){yield this.x,yield this.y,yield this.z}toJSON(){return{type:A.type,x:this.x,y:this.y,z:this.z}}static fromJSON(e){return z(e.type,A.type),new A(e.x,e.y,e.z)}};c(A,"type","_Vector3");let m=A;const Q=class Q extends m{get r(){return this.x}set r(e){this.x=e}get g(){return this.y}set g(e){this.y=e}get b(){return this.z}set b(e){this.z=e}toJSON(){return{type:Q.type,x:this.x,y:this.y,z:this.z}}static fromJSON(e){return z(e.type,Q.type),new Q(e.x,e.y,e.z)}clone(){return new Q(this.x,this.y,this.z)}};c(Q,"type","_Color"),c(Q,"Red",new Q(1,0,0)),c(Q,"Black",new Q(0,0,0));let v=Q;class le{constructor(e){c(this,"axis");const t=e.clone().normalize(),r=Math.abs(t.x)>.9?new m(0,1,0):new m(1,0,0),i=t.clone().cross(r).normalize(),o=t.clone().cross(i);this.axis=[o,i,t]}get u(){return this.axis[0]}get v(){return this.axis[1]}get w(){return this.axis[2]}transform(e){return new m(0,0,0).addScaledVector(this.axis[0],e.x).addScaledVector(this.axis[1],e.y).addScaledVector(this.axis[2],e.z)}}class fe{}const Tt=class Tt extends fe{value(e){return Tt._pdf}generate(){return he()}};c(Tt,"_pdf",1/4/Math.PI);let Ut=Tt;class Oe extends fe{constructor(t){super();c(this,"uvw");this.uvw=new le(t)}value(t){const r=t.clone().normalize().dot(this.uvw.w);return Math.max(0,r/Math.PI)}generate(){return this.uvw.transform(Se())}}const rt=class rt{constructor(e,t,r){c(this,"origin");c(this,"dir");c(this,"norm_dir");c(this,"tm");this.origin=e,this.dir=t,this.norm_dir=t.clone().normalize(),this.tm=r}at(e){return this.origin.clone().addScaledVector(this.dir,e)}toJSON(){return{type:rt.type,origin:this.origin.toJSON(),dir:this.dir.toJSON(),tm:this.tm}}static fromJSON(e){return z(e.type,rt.type),new rt(m.fromJSON(e.origin),m.fromJSON(e.dir),e.tm)}};c(rt,"type","_Ray");let D=rt;function Ne(n){return n.aspect_ratio=n.aspect_ratio??1,n.image_width=n.image_width??100,n.samples_per_pixel=n.samples_per_pixel??10,n.max_depth=n.max_depth??10,n.background=n.background??new v(.7,.8,1),n.vfov=n.vfov??90,n.lookfrom=n.lookfrom??new m(0,0,0),n.lookat=n.lookat??new m(0,0,-1),n.vup=n.vup??new m(0,1,0),n.defocus_angle=n.defocus_angle??0,n.focus_dist=n.focus_dist??10,n}const it=class it{constructor(e){c(this,"aspect_ratio");c(this,"image_width");c(this,"image_height");c(this,"vfov");c(this,"center");c(this,"lookfrom");c(this,"lookat");c(this,"vup");c(this,"focus_dist");c(this,"defocus_angle");c(this,"samples_per_pixel");c(this,"max_depth");c(this,"background");c(this,"pixel_samples_scale");c(this,"sqrt_spp");c(this,"recip_sqrt_spp");c(this,"pixel_delta_u");c(this,"pixel_delta_v");c(this,"pixel00_loc");c(this,"defocus_disk_u");c(this,"defocus_disk_v");const{aspect_ratio:t,image_width:r,samples_per_pixel:i,max_depth:o,vfov:l,lookfrom:h,lookat:s,vup:a,focus_dist:f,defocus_angle:u,background:d}=Ne(e||{});this.samples_per_pixel=i,this.sqrt_spp=Math.floor(i**.5),this.pixel_samples_scale=1/this.sqrt_spp**2,this.recip_sqrt_spp=1/this.sqrt_spp,this.max_depth=o,this.background=d,this.aspect_ratio=t,this.image_width=r,this.vfov=l;const x=this.image_height=Math.floor(r/t);this.lookfrom=h,this.lookat=s,this.vup=a,this.center=h,this.focus_dist=f,this.defocus_angle=u;const y=2*Math.tan(Gt(l)/2)*f,S=y*r/x,b=h.clone().sub(s).normalize(),j=a.clone().cross(b).normalize(),C=b.clone().cross(j),w=j.clone().multiplyScalar(S),g=C.clone().multiplyScalar(-y);this.pixel_delta_u=w.clone().divideScalar(r),this.pixel_delta_v=g.clone().divideScalar(x),this.pixel00_loc=this.center.clone().addScaledVector(b,-f).addScaledVector(w,-.5).addScaledVector(g,-.5).addScaledVector(this.pixel_delta_u,.5).addScaledVector(this.pixel_delta_v,.5);const O=f*Math.tan(Gt(u/2));this.defocus_disk_u=j.clone().multiplyScalar(O),this.defocus_disk_v=C.clone().multiplyScalar(O)}toJSON(){return{type:it.type,aspect_ratio:this.aspect_ratio,image_width:this.image_width,samples_per_pixel:this.samples_per_pixel,max_depth:this.max_depth,background:this.background.toJSON(),vfov:this.vfov,lookfrom:this.lookfrom.toJSON(),lookat:this.lookat.toJSON(),vup:this.vup.toJSON(),focus_dist:this.focus_dist,defocus_angle:this.defocus_angle}}static fromJSON(e){return z(e.type,it.type),new it({...e,background:v.fromJSON(e.background),lookfrom:m.fromJSON(e.lookfrom),lookat:m.fromJSON(e.lookat),vup:m.fromJSON(e.vup)})}};c(it,"type","_Camera");let Lt=it;var Je=typeof global=="object"&&global&&global.Object===Object&&global,Me=typeof self=="object"&&self&&self.Object===Object&&self,je=Je||Me||Function("return this")(),jt=je.Symbol,de=Object.prototype,ke=de.hasOwnProperty,qe=de.toString,gt=jt?jt.toStringTag:void 0;function Ie(n){var e=ke.call(n,gt),t=n[gt];try{n[gt]=void 0;var r=!0}catch{}var i=qe.call(n);return r&&(e?n[gt]=t:delete n[gt]),i}var Pe=Object.prototype,Ee=Pe.toString;function $e(n){return Ee.call(n)}var Te="[object Null]",Ce="[object Undefined]",ie=jt?jt.toStringTag:void 0;function Ve(n){return n==null?n===void 0?Ce:Te:ie&&ie in Object(n)?Ie(n):$e(n)}function Qe(n){return n!=null&&typeof n=="object"}var De="[object Symbol]";function Xe(n){return typeof n=="symbol"||Qe(n)&&Ve(n)==De}var Re=/\s/;function Fe(n){for(var e=n.length;e--&&Re.test(n.charAt(e)););return e}var Ge=/^\s+/;function Ue(n){return n&&n.slice(0,Fe(n)+1).replace(Ge,"")}function se(n){var e=typeof n;return n!=null&&(e=="object"||e=="function")}var oe=NaN,Le=/^[-+]0x[0-9a-f]+$/i,We=/^0b[01]+$/i,Ye=/^0o[0-7]+$/i,Ze=parseInt;function Dt(n){if(typeof n=="number")return n;if(Xe(n))return oe;if(se(n)){var e=typeof n.valueOf=="function"?n.valueOf():n;n=se(e)?e+"":e}if(typeof n!="string")return n===0?n:+n;n=Ue(n);var t=We.test(n);return t||Ye.test(n)?Ze(n.slice(2),t?2:8):Le.test(n)?oe:+n}function He(n,e,t){return n===n&&(t!==void 0&&(n=n<=t?n:t),e!==void 0&&(n=n>=e?n:e)),n}function kt(n,e,t){return t===void 0&&(t=e,e=void 0),t!==void 0&&(t=Dt(t),t=t===t?t:0),e!==void 0&&(e=Dt(e),e=e===e?e:0),He(Dt(n),e,t)}const Ae=typeof importScripts<"u",Wt=Ae?new OffscreenCanvas(1,1):document.createElement("canvas"),ae=Wt.getContext("2d");function Be(n){return Wt.width=n.width,Wt.height=n.height,ae.drawImage(n,0,0),ae.getImageData(0,0,n.width,n.height)}class Ke{constructor(e){c(this,"src");c(this,"image_width");c(this,"image_height");c(this,"clamp_range");c(this,"bdata");this.src=e}get loaded(){return!!this.bdata}get width(){return this.image_width}get height(){return this.image_height}async load(){const e=await ze(this.src);this.image_width=e.width,this.image_height=e.height,this.clamp_range=[e.width-1,e.height-1],this.bdata=Be(e)}pixel_data(e,t){if(!this.bdata)return[255,0,255,255];const[r,i]=this.clamp_range;e=kt(e,0,r),t=kt(t,0,i);const o=(t*this.image_width+e)*4,l=this.bdata.data;return[l[o],l[o+1],l[o+2],l[o+3]]}}var tt=typeof globalThis<"u"?globalThis:typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{};function tn(n){return n&&n.__esModule&&Object.prototype.hasOwnProperty.call(n,"default")?n.default:n}function en(n){if(n.__esModule)return n;var e=n.default;if(typeof e=="function"){var t=function r(){return this instanceof r?Reflect.construct(e,arguments,this.constructor):e.apply(this,arguments)};t.prototype=e.prototype}else t={};return Object.defineProperty(t,"__esModule",{value:!0}),Object.keys(n).forEach(function(r){var i=Object.getOwnPropertyDescriptor(n,r);Object.defineProperty(t,r,i.get?i:{enumerable:!0,get:function(){return n[r]}})}),t}var Ht={exports:{}};Ht.exports;(function(n){(function(e,t,r){function i(s){var a=this,f=h();a.next=function(){var u=2091639*a.s0+a.c*23283064365386963e-26;return a.s0=a.s1,a.s1=a.s2,a.s2=u-(a.c=u|0)},a.c=1,a.s0=f(" "),a.s1=f(" "),a.s2=f(" "),a.s0-=f(s),a.s0<0&&(a.s0+=1),a.s1-=f(s),a.s1<0&&(a.s1+=1),a.s2-=f(s),a.s2<0&&(a.s2+=1),f=null}function o(s,a){return a.c=s.c,a.s0=s.s0,a.s1=s.s1,a.s2=s.s2,a}function l(s,a){var f=new i(s),u=a&&a.state,d=f.next;return d.int32=function(){return f.next()*4294967296|0},d.double=function(){return d()+(d()*2097152|0)*11102230246251565e-32},d.quick=d,u&&(typeof u=="object"&&o(u,f),d.state=function(){return o(f,{})}),d}function h(){var s=4022871197,a=function(f){f=String(f);for(var u=0;u<f.length;u++){s+=f.charCodeAt(u);var d=.02519603282416938*s;s=d>>>0,d-=s,d*=s,s=d>>>0,d-=s,s+=d*4294967296}return(s>>>0)*23283064365386963e-26};return a}t&&t.exports?t.exports=l:this.alea=l})(tt,n)})(Ht);var nn=Ht.exports,At={exports:{}};At.exports;(function(n){(function(e,t,r){function i(h){var s=this,a="";s.x=0,s.y=0,s.z=0,s.w=0,s.next=function(){var u=s.x^s.x<<11;return s.x=s.y,s.y=s.z,s.z=s.w,s.w^=s.w>>>19^u^u>>>8},h===(h|0)?s.x=h:a+=h;for(var f=0;f<a.length+64;f++)s.x^=a.charCodeAt(f)|0,s.next()}function o(h,s){return s.x=h.x,s.y=h.y,s.z=h.z,s.w=h.w,s}function l(h,s){var a=new i(h),f=s&&s.state,u=function(){return(a.next()>>>0)/4294967296};return u.double=function(){do var d=a.next()>>>11,x=(a.next()>>>0)/4294967296,p=(d+x)/(1<<21);while(p===0);return p},u.int32=a.next,u.quick=u,f&&(typeof f=="object"&&o(f,a),u.state=function(){return o(a,{})}),u}t&&t.exports?t.exports=l:this.xor128=l})(tt,n)})(At);var rn=At.exports,Bt={exports:{}};Bt.exports;(function(n){(function(e,t,r){function i(h){var s=this,a="";s.next=function(){var u=s.x^s.x>>>2;return s.x=s.y,s.y=s.z,s.z=s.w,s.w=s.v,(s.d=s.d+362437|0)+(s.v=s.v^s.v<<4^(u^u<<1))|0},s.x=0,s.y=0,s.z=0,s.w=0,s.v=0,h===(h|0)?s.x=h:a+=h;for(var f=0;f<a.length+64;f++)s.x^=a.charCodeAt(f)|0,f==a.length&&(s.d=s.x<<10^s.x>>>4),s.next()}function o(h,s){return s.x=h.x,s.y=h.y,s.z=h.z,s.w=h.w,s.v=h.v,s.d=h.d,s}function l(h,s){var a=new i(h),f=s&&s.state,u=function(){return(a.next()>>>0)/4294967296};return u.double=function(){do var d=a.next()>>>11,x=(a.next()>>>0)/4294967296,p=(d+x)/(1<<21);while(p===0);return p},u.int32=a.next,u.quick=u,f&&(typeof f=="object"&&o(f,a),u.state=function(){return o(a,{})}),u}t&&t.exports?t.exports=l:this.xorwow=l})(tt,n)})(Bt);var sn=Bt.exports,Kt={exports:{}};Kt.exports;(function(n){(function(e,t,r){function i(h){var s=this;s.next=function(){var f=s.x,u=s.i,d,x;return d=f[u],d^=d>>>7,x=d^d<<24,d=f[u+1&7],x^=d^d>>>10,d=f[u+3&7],x^=d^d>>>3,d=f[u+4&7],x^=d^d<<7,d=f[u+7&7],d=d^d<<13,x^=d^d<<9,f[u]=x,s.i=u+1&7,x};function a(f,u){var d,x=[];if(u===(u|0))x[0]=u;else for(u=""+u,d=0;d<u.length;++d)x[d&7]=x[d&7]<<15^u.charCodeAt(d)+x[d+1&7]<<13;for(;x.length<8;)x.push(0);for(d=0;d<8&&x[d]===0;++d);for(d==8?x[7]=-1:x[d],f.x=x,f.i=0,d=256;d>0;--d)f.next()}a(s,h)}function o(h,s){return s.x=h.x.slice(),s.i=h.i,s}function l(h,s){h==null&&(h=+new Date);var a=new i(h),f=s&&s.state,u=function(){return(a.next()>>>0)/4294967296};return u.double=function(){do var d=a.next()>>>11,x=(a.next()>>>0)/4294967296,p=(d+x)/(1<<21);while(p===0);return p},u.int32=a.next,u.quick=u,f&&(f.x&&o(f,a),u.state=function(){return o(a,{})}),u}t&&t.exports?t.exports=l:this.xorshift7=l})(tt,n)})(Kt);var on=Kt.exports,te={exports:{}};te.exports;(function(n){(function(e,t,r){function i(h){var s=this;s.next=function(){var f=s.w,u=s.X,d=s.i,x,p;return s.w=f=f+1640531527|0,p=u[d+34&127],x=u[d=d+1&127],p^=p<<13,x^=x<<17,p^=p>>>15,x^=x>>>12,p=u[d]=p^x,s.i=d,p+(f^f>>>16)|0};function a(f,u){var d,x,p,y,S,b=[],j=128;for(u===(u|0)?(x=u,u=null):(u=u+"\0",x=0,j=Math.max(j,u.length)),p=0,y=-32;y<j;++y)u&&(x^=u.charCodeAt((y+32)%u.length)),y===0&&(S=x),x^=x<<10,x^=x>>>15,x^=x<<4,x^=x>>>13,y>=0&&(S=S+1640531527|0,d=b[y&127]^=x+S,p=d==0?p+1:0);for(p>=128&&(b[(u&&u.length||0)&127]=-1),p=127,y=4*128;y>0;--y)x=b[p+34&127],d=b[p=p+1&127],x^=x<<13,d^=d<<17,x^=x>>>15,d^=d>>>12,b[p]=x^d;f.w=S,f.X=b,f.i=p}a(s,h)}function o(h,s){return s.i=h.i,s.w=h.w,s.X=h.X.slice(),s}function l(h,s){h==null&&(h=+new Date);var a=new i(h),f=s&&s.state,u=function(){return(a.next()>>>0)/4294967296};return u.double=function(){do var d=a.next()>>>11,x=(a.next()>>>0)/4294967296,p=(d+x)/(1<<21);while(p===0);return p},u.int32=a.next,u.quick=u,f&&(f.X&&o(f,a),u.state=function(){return o(a,{})}),u}t&&t.exports?t.exports=l:this.xor4096=l})(tt,n)})(te);var an=te.exports,ee={exports:{}};ee.exports;(function(n){(function(e,t,r){function i(h){var s=this,a="";s.next=function(){var u=s.b,d=s.c,x=s.d,p=s.a;return u=u<<25^u>>>7^d,d=d-x|0,x=x<<24^x>>>8^p,p=p-u|0,s.b=u=u<<20^u>>>12^d,s.c=d=d-x|0,s.d=x<<16^d>>>16^p,s.a=p-u|0},s.a=0,s.b=0,s.c=-1640531527,s.d=1367130551,h===Math.floor(h)?(s.a=h/4294967296|0,s.b=h|0):a+=h;for(var f=0;f<a.length+20;f++)s.b^=a.charCodeAt(f)|0,s.next()}function o(h,s){return s.a=h.a,s.b=h.b,s.c=h.c,s.d=h.d,s}function l(h,s){var a=new i(h),f=s&&s.state,u=function(){return(a.next()>>>0)/4294967296};return u.double=function(){do var d=a.next()>>>11,x=(a.next()>>>0)/4294967296,p=(d+x)/(1<<21);while(p===0);return p},u.int32=a.next,u.quick=u,f&&(typeof f=="object"&&o(f,a),u.state=function(){return o(a,{})}),u}t&&t.exports?t.exports=l:this.tychei=l})(tt,n)})(ee);var cn=ee.exports,xe={exports:{}};const un={},hn=Object.freeze(Object.defineProperty({__proto__:null,default:un},Symbol.toStringTag,{value:"Module"})),ln=en(hn);(function(n){(function(e,t,r){var i=256,o=6,l=52,h="random",s=r.pow(i,o),a=r.pow(2,l),f=a*2,u=i-1,d;function x(w,g,O){var J=[];g=g==!0?{entropy:!0}:g||{};var N=b(S(g.entropy?[w,C(t)]:w??j(),3),J),E=new p(J),V=function(){for(var $=E.g(o),U=s,R=0;$<a;)$=($+R)*i,U*=i,R=E.g(1);for(;$>=f;)$/=2,U/=2,R>>>=1;return($+R)/U};return V.int32=function(){return E.g(4)|0},V.quick=function(){return E.g(4)/4294967296},V.double=V,b(C(E.S),t),(g.pass||O||function($,U,R,L){return L&&(L.S&&y(L,E),$.state=function(){return y(E,{})}),R?(r[h]=$,U):$})(V,N,"global"in g?g.global:this==r,g.state)}function p(w){var g,O=w.length,J=this,N=0,E=J.i=J.j=0,V=J.S=[];for(O||(w=[O++]);N<i;)V[N]=N++;for(N=0;N<i;N++)V[N]=V[E=u&E+w[N%O]+(g=V[N])],V[E]=g;(J.g=function($){for(var U,R=0,L=J.i,Mt=J.j,wt=J.S;$--;)U=wt[L=u&L+1],R=R*i+wt[u&(wt[L]=wt[Mt=u&Mt+U])+(wt[Mt]=U)];return J.i=L,J.j=Mt,R})(i)}function y(w,g){return g.i=w.i,g.j=w.j,g.S=w.S.slice(),g}function S(w,g){var O=[],J=typeof w,N;if(g&&J=="object")for(N in w)try{O.push(S(w[N],g-1))}catch{}return O.length?O:J=="string"?w:w+"\0"}function b(w,g){for(var O=w+"",J,N=0;N<O.length;)g[u&N]=u&(J^=g[u&N]*19)+O.charCodeAt(N++);return C(g)}function j(){try{var w;return d&&(w=d.randomBytes)?w=w(i):(w=new Uint8Array(i),(e.crypto||e.msCrypto).getRandomValues(w)),C(w)}catch{var g=e.navigator,O=g&&g.plugins;return[+new Date,e,O,e.screen,C(t)]}}function C(w){return String.fromCharCode.apply(0,w)}if(b(r.random(),t),n.exports){n.exports=x;try{d=ln}catch{}}else r["seed"+h]=x})(typeof self<"u"?self:tt,[],Math)})(xe);var fn=xe.exports,dn=nn,xn=rn,mn=sn,pn=on,yn=an,wn=cn,et=fn;et.alea=dn;et.xor128=xn;et.xorwow=mn;et.xorshift7=pn;et.xor4096=yn;et.tychei=wn;var gn=et;const bn=tn(gn),k=class k{constructor(e){c(this,"seed");c(this,"prng");c(this,"randvec");c(this,"perm_x");c(this,"perm_y");c(this,"perm_z");this.seed=e,this.prng=bn(e),this.randvec=[];for(let t=0;t<k.point_count;t++)this.randvec[t]=new m(this.random(-1,1),this.random(-1,1),this.random(-1,1)).normalize();this.perm_x=this.perlin_generate_perm(),this.perm_y=this.perlin_generate_perm(),this.perm_z=this.perlin_generate_perm()}noise(e){const t=Qt(e.x),r=Qt(e.y),i=Qt(e.z),o=Math.floor(e.x),l=Math.floor(e.y),h=Math.floor(e.z),s=[[[],[]],[[],[]]];for(let a=0;a<2;a++)for(let f=0;f<2;f++)for(let u=0;u<2;u++)s[a][f][u]=this.randvec[this.perm_x[o+a&255]^this.perm_y[l+f&255]^this.perm_z[h+u&255]];return k.trilinear_interp(s,t,r,i)}turb(e,t){let r=0;const i=e.clone();let o=1;for(let l=0;l<t;l++)r+=o*this.noise(i),o*=.5,i.multiplyScalar(2);return Math.abs(r)}static hermite_cubic_interp(e){return e*e*(3-2*e)}static trilinear_interp(e,t,r,i){const o=k.hermite_cubic_interp(t),l=k.hermite_cubic_interp(r),h=k.hermite_cubic_interp(i);let s=0;const a=new m;for(let f=0;f<2;f++)for(let u=0;u<2;u++)for(let d=0;d<2;d++)a.set(t-f,r-u,i-d),s+=(f*o+(1-f)*(1-o))*(u*l+(1-u)*(1-l))*(d*h+(1-d)*(1-h))*a.dot(e[f][u][d]);return s}toJSON(){return{type:k.type,seed:this.seed}}static fromJSON(e){return z(e.type,k.type),new k(e.seed)}random(e=0,t=1){return(t-e)*this.prng()+e}random_int(e,t){return Math.floor(this.random(e,t+1))}perlin_generate_perm(){const e=[];for(let t=0;t<k.point_count;t++)e[t]=t;return this.permute(e,k.point_count),e}permute(e,t){for(let r=t-1;r>0;r--){const i=this.random_int(0,r),o=e[r];e[r]=e[i],e[i]=o}}};c(k,"type","_Perlin"),c(k,"point_count",256);let Yt=k;const st=class st{constructor(...e){c(this,"albedo");typeof e[0]=="number"?this.albedo=new v(e[0],e[1],e[2]):this.albedo=e[0]}value(e,t,r){return this.albedo}toJSON(){return{type:st.type,albedo:this.albedo.toJSON()}}static fromJSON(e){return z(e.type,st.type),new st(v.fromJSON(e.albedo))}};c(st,"type","_SolidColorTexture");let F=st;const ot=class ot{constructor(...e){c(this,"even");c(this,"odd");c(this,"inv_scale");e[1]instanceof v?(this.inv_scale=1/e[0],this.even=new F(e[1]),this.odd=new F(e[2])):(this.inv_scale=1/e[0],this.even=e[1],this.odd=e[2])}value(e,t,r){const i=Math.floor(this.inv_scale*r.x),o=Math.floor(this.inv_scale*r.y),l=Math.floor(this.inv_scale*r.z);return(i+o+l)%2===0?this.even.value(e,t,r):this.odd.value(e,t,r)}toJSON(){return{type:ot.type,scale:1/this.inv_scale,even:this.even.toJSON(),odd:this.odd.toJSON()}}static fromJSON(e){return z(e.type,ot.type),new ot(e.scale,yt(e.even),yt(e.odd))}};c(ot,"type","_CheckerTexture");let qt=ot;const at=class at{constructor(e){c(this,"image");c(this,"src");this.src=e,this.image=new Ke(e)}load(){return this.image.load()}value(e,t,r){if(!this.image.loaded)return new v(0,1,1);e=kt(e,0,1),t=1-kt(t,0,1);const i=Math.floor(e*this.image.width),o=Math.floor(t*this.image.height),l=this.image.pixel_data(i,o);return new v(l[0]/255,l[1]/255,l[2]/255)}toJSON(){return{type:at.type,src:this.src}}static fromJSON(e){return z(e.type,at.type),new at(e.src)}};c(at,"type","_ImageTexture");let bt=at;const ct=class ct{constructor(e){c(this,"noise");c(this,"scale");this.scale=e,this.noise=new Yt("perlin-noise-seed")}value(e,t,r){return new v(1,1,1).multiplyScalar(.5).multiplyScalar(1+Math.sin(this.scale*r.z+10*this.noise.turb(r,7)))}toJSON(){return{type:ct.type,noise:this.noise.toJSON(),scale:this.scale}}static fromJSON(e){return z(e.type,ct.type),new ct(e.scale)}};c(ct,"type","_NoiseTexture");let It=ct;function yt(n){switch(n.type){case v.type:return new F(v.fromJSON(n));case F.type:return F.fromJSON(n);case qt.type:return qt.fromJSON(n);case bt.type:return bt.fromJSON(n);case It.type:return It.fromJSON(n);default:throw new Error("无效的texture类型:"+n.type)}}const M=class M{constructor(...e){c(this,"x");c(this,"y");c(this,"z");if(!e.length){this.x=new _,this.y=new _,this.z=new _;return}const t=e[0];if(t instanceof _){const[r,i,o]=e;this.x=r,this.y=i,this.z=o}else if(t instanceof m){const[r,i]=e;this.x=r.x<i.x?new _(r.x,i.x):new _(i.x,r.x),this.y=r.y<i.y?new _(r.y,i.y):new _(i.y,r.y),this.z=r.z<i.z?new _(r.z,i.z):new _(i.z,r.z)}else if(t instanceof M){const[r,i]=e;this.x=new _(r.x,i.x),this.y=new _(r.y,i.y),this.z=new _(r.z,i.z)}this.pad_to_minimums()}pad_to_minimums(){this.x.size()<M.delta&&this.x.expand(M.delta),this.y.size()<M.delta&&this.y.expand(M.delta),this.z.size()<M.delta&&this.z.expand(M.delta)}get_axis_interval(e){return e===I.Y?this.y:e===I.Z?this.z:this.x}hit(e,t){const{origin:r,dir:i}=e,o=t.clone();for(let l=0;l<3;l++){const h=this.get_axis_interval(l),s=1/i.getComponent(l),a=(h.min-r.getComponent(l))*s,f=(h.max-r.getComponent(l))*s;if(a<f?(a>o.min&&(o.min=a),f<o.max&&(o.max=f)):(f>o.min&&(o.min=f),a<o.max&&(o.max=a)),o.max<=o.min)return!1}return!0}longest_axis(){const e=this.x.size(),t=this.y.size(),r=this.z.size();return e>t?e>r?I.X:I.Z:t>r?I.Y:I.Z}add_offset(e){return this.x.add_offset(e.x),this.y.add_offset(e.y),this.z.add_offset(e.z),this}clone(){return new M(this.x.clone(),this.y.clone(),this.z.clone())}};c(M,"Empty",new M(_.Empty,_.Empty,_.Empty)),c(M,"Universe",new M(_.Universe,_.Universe,_.Universe)),c(M,"delta",1e-4);let P=M;class Vt{constructor(){c(this,"attenuation");c(this,"pdf");c(this,"skip_pdf");c(this,"skip_pdf_ray")}}class ne{constructor(){c(this,"p");c(this,"normal");c(this,"t");c(this,"front_face");c(this,"mat");c(this,"u");c(this,"v")}set_face_normal(e,t){this.front_face=e.dir.dot(t)<0,this.normal=this.front_face?t:t.clone().multiplyScalar(-1)}}class nt{pdf_value(e,t){return 0}random(e){return new m(1,0,0)}}const ut=class ut extends nt{constructor(t,r){super();c(this,"offset");c(this,"object");c(this,"bbox");this.object=t,this.offset=r,this.bbox=t.bounding_box().clone().add_offset(r)}bounding_box(){return this.bbox}hit(t,r){const i=new D(t.origin.clone().sub(this.offset),t.dir,t.tm),o=this.object.hit(i,r);return o?(o.p.add(this.offset),o):!1}toJSON(){return{type:ut.type,offset:this.offset.toJSON(),object:this.object.toJSON()}}static fromJSON(t){return z(ut.type,t.type),new ut(Jt(t.object),m.fromJSON(t.offset))}};c(ut,"type","_Translate");let _t=ut;const ht=class ht extends nt{constructor(t,r){super();c(this,"sin_theta");c(this,"cos_theta");c(this,"bbox");c(this,"object");c(this,"angle");this.angle=r,this.object=t;const i=Gt(r);this.sin_theta=Math.sin(i),this.cos_theta=Math.cos(i);const o=t.bounding_box(),l=new m(1/0,1/0,1/0),h=new m(-1/0,-1/0,-1/0);for(let s=0;s<2;s++)for(let a=0;a<2;a++)for(let f=0;f<2;f++){const u=s*o.x.max+(1-s)*o.x.min,d=a*o.y.max+(1-a)*o.y.min,x=f*o.z.max+(1-f)*o.z.min,p=this.cos_theta*u+this.sin_theta*x,y=-this.sin_theta*u+this.cos_theta*x;l.x=Math.min(l.x,p),l.y=Math.min(l.y,d),l.z=Math.min(l.z,y),h.x=Math.max(h.x,p),h.y=Math.max(h.y,d),h.z=Math.max(h.z,y)}this.bbox=new P(l,h)}bounding_box(){return this.bbox}hit(t,r){const{cos_theta:i,sin_theta:o}=this,l=new m(i*t.origin.x-o*t.origin.z,t.origin.y,o*t.origin.x+i*t.origin.z),h=new m(i*t.dir.x-o*t.dir.z,t.dir.y,o*t.dir.x+i*t.dir.z),s=new D(l,h,t.tm),a=this.object.hit(s,r);return a?(a.p=new m(i*a.p.x+o*a.p.z,a.p.y,-o*a.p.x+i*a.p.z),a.normal=new m(i*a.normal.x+o*a.normal.z,a.normal.y,-o*a.normal.x+i*a.normal.z),a):!1}toJSON(){return{type:ht.type,object:this.object.toJSON(),angle:this.angle}}static fromJSON(t){return z(t.type,ht.type),new ht(Jt(t.object),t.angle)}};c(ht,"type","_Rotate_Y");let vt=ht;const lt=class lt extends nt{constructor(t){super();c(this,"objects");c(this,"bbox");this.objects=[],this.bbox=new P,this.add(t)}pdf_value(t,r){1/this.objects.length;let i=0;for(let o of this.objects)i+=o.pdf_value(t,r);return i}random(t){const r=be(0,this.objects.length-1);return this.objects[r].random(t)}bounding_box(){return this.bbox}add(t){return t?(this.objects.push(t),this.bbox=new P(this.bbox,t.bounding_box()),this):this}hit(t,r){let i=!1,o=r.max;for(let l of this.objects){const h=l.hit(t,new _(r.min,o));h&&(o=h.t,i=h)}return i}toJSON(){return{type:lt.type,objects:this.objects.map(t=>t.toJSON())}}static fromJSON(t){z(t.type,lt.type);const r=new lt;return t.objects.forEach(i=>{r.add(Jt(i))}),r}};c(lt,"type","_HittableList");let K=lt;const ft=class ft extends nt{constructor(t,r,i,o){super();c(this,"Q");c(this,"u");c(this,"v");c(this,"area");c(this,"material");c(this,"bbox");c(this,"normal");c(this,"D");c(this,"w");this.Q=t,this.u=r,this.v=i,this.material=o;const l=r.clone().cross(i);this.area=l.length(),this.normal=l.clone().normalize(),this.D=this.normal.dot(t),this.w=l.clone().divideScalar(l.dot(l)),this.update_bbox()}update_bbox(){const t=new P(this.Q,this.Q.clone().add(this.u).add(this.v)),r=new P(this.Q.clone().add(this.u),this.Q.clone().add(this.v));this.bbox=new P(t,r)}bounding_box(){return this.bbox}pdf_value(t,r){const i=this.hit(new D(t,r,0),new _(.001,1/0));if(!i)return 0;const o=i.t*i.t*r.lengthSquared(),l=Math.abs(r.dot(i.normal)/r.length());return o/(l*this.area)}random(t){return this.Q.clone().addScaledVector(this.u,X()).addScaledVector(this.v,X()).sub(t)}hit(t,r){const i=this.normal.dot(t.dir);if(Math.abs(i)<1e-8)return!1;const o=(this.D-this.normal.dot(t.origin))/i;if(!r.contains(o))return!1;const l=t.at(o),h=l.clone().sub(this.Q),s=this.w.dot(h.clone().cross(this.v)),a=this.w.dot(this.u.clone().cross(h));if(s<0||s>1||a<0||a>1)return!1;const f=new ne;return f.p=l,f.t=o,f.mat=this.material,f.u=s,f.v=a,f.set_face_normal(t,this.normal),f}toJSON(){return{type:ft.type,Q:this.Q.toJSON(),u:this.u.toJSON(),v:this.v.toJSON(),material:this.material.toJSON()}}static fromJSON(t){return z(t.type,ft.type),new ft(m.fromJSON(t.Q),m.fromJSON(t.u),m.fromJSON(t.v),me(t.material))}};c(ft,"type","_Quad");let T=ft;const W=class W extends nt{constructor(...t){super();c(this,"bbox");c(this,"center");c(this,"radius");c(this,"material");if(t.length!==0){if(typeof t[1]=="number"){const[r,i,o]=t;this.center=new D(r,new m(0,0,0),0),this.radius=i,this.material=o}else{const[r,i,o,l]=t;this.center=new D(r,i.clone().sub(r),0),this.radius=o,this.material=l}this.update_bbox()}}static get_sphere_uv(t){const{x:r,y:i,z:o}=t,l=Math.acos(-i);return[(Math.atan2(-o,r)+Math.PI)/(2*Math.PI),l/Math.PI]}update_bbox(){const{center:t,radius:r}=this,i=new m(r,r,r),o=new P(t.at(0).sub(i),t.at(0).add(i)),l=new P(t.at(1).sub(i),t.at(1).add(i));this.bbox=new P(o,l)}bounding_box(){return this.bbox}pdf_value(t,r){if(!this.hit(new D(t,r,0),new _(1e-4,1/0)))return 0;const o=this.center.at(0).sub(t).lengthSquared(),l=(1-this.radius*this.radius/o)**.5;return 1/(2*Math.PI*(1-l))}random(t){const r=this.center.at(0).sub(t),i=r.lengthSquared();return new le(r).transform(W.random_to_sphere(this.radius,i))}hit(t,r){const i=this.center.at(t.tm),o=i.clone().sub(t.origin),l=t.dir.lengthSquared(),h=t.dir.dot(o),s=o.lengthSquared()-this.radius*this.radius,a=h*h-l*s;if(a<0)return!1;const f=a**.5;let u=(h-f)/l;if(!r.surrounds(u)&&(u=(h+f)/l,!r.surrounds(u)))return!1;const d=new ne;d.t=u,d.p=t.at(d.t),d.mat=this.material;const x=d.p.clone().sub(i).divideScalar(this.radius);d.set_face_normal(t,x);const p=W.get_sphere_uv(x);return d.u=p[0],d.v=p[1],d}static random_to_sphere(t,r){const i=X(),o=X(),l=(1-t*t/r)**.5,h=1+o*(l-1),s=2*Math.PI*i,a=(1-h**2)**.5;return new m(Math.cos(s)*a,Math.sin(s)*a,h)}toJSON(){return{type:W.type,center:this.center.toJSON(),radius:this.radius,material:this.material.toJSON()}}static fromJSON(t){z(t.type,W.type);const r=new W;return r.center=D.fromJSON(t.center),r.radius=t.radius,r.material=me(t.material),r.update_bbox(),r}};c(W,"type","_Sphere");let St=W;const dt=class dt extends nt{constructor(t,r,i){super();c(this,"_density");c(this,"_tex_or_albedo");c(this,"boundary");c(this,"neg_inv_density");c(this,"phase_function");this._density=r,this._tex_or_albedo=i,this.boundary=t,this.neg_inv_density=-1/r,this.phase_function=new Nt(i)}hit(t,r){const i=this.boundary.hit(t,_.Universe);if(!i)return!1;const o=this.boundary.hit(t,new _(i.t+1e-4,1/0));if(!o||(i.t<r.min&&(i.t=r.min),o.t>r.max&&(o.t=r.max),i.t>o.t))return!1;i.t<0&&(i.t=0);const l=t.dir.length(),h=(o.t-i.t)*l,s=this.neg_inv_density*Math.log(X());if(s>h)return!1;const a=new ne;return a.t=i.t+s/l,a.p=t.at(a.t),a.normal=new m(1,0,0),a.front_face=!0,a.mat=this.phase_function,a}bounding_box(){return this.boundary.bounding_box()}toJSON(){return{type:dt.type,boundary:this.boundary.toJSON(),density:this._density,tex_or_albedo:this._tex_or_albedo.toJSON()}}static fromJSON(t){return z(t.type,dt.type),new dt(Jt(t.boundary),t.density,t.tex_or_albedo.type===v.type?v.fromJSON(t.tex_or_albedo):yt(t.tex_or_albedo))}};c(dt,"type","_ConstantMedium");let Pt=dt;const q=class q extends nt{constructor(t){super();c(this,"objects");c(this,"left");c(this,"right");c(this,"bbox");this.objects=t,this.bbox=t.reduce((l,h)=>(l=new P(l,h.bounding_box()),l),P.Empty);const r=this.bbox.longest_axis(),i=r===I.X?q.box_x_compare:r===I.Y?q.box_y_compare:q.box_z_compare,o=t.length;if(o===1)this.left=this.right=t[0];else if(o===2)this.left=t[0],this.right=t[1];else{t.sort(i);const l=Math.floor(o/2);this.left=new q(t.slice(0,l)),this.right=new q(t.slice(l))}}hit(t,r){if(!this.bbox.hit(t,r))return!1;const i=this.left.hit(t,r);return this.right.hit(t,new _(r.min,i?i.t:r.max))||i}bounding_box(){return this.bbox}toJSON(){return{type:q.type,objects:this.objects.map(t=>t.toJSON())}}static fromJSON(t){return z(t.type,q.type),new q(t.objects.map(r=>Jt(r)))}static box_compare(t,r,i){const o=t.bounding_box().get_axis_interval(i),l=r.bounding_box().get_axis_interval(i);return o.min-l.min}static box_x_compare(t,r){return q.box_compare(t,r,I.X)}static box_y_compare(t,r){return q.box_compare(t,r,I.Y)}static box_z_compare(t,r){return q.box_compare(t,r,I.Z)}};c(q,"type","_BvhNode");let Et=q;function _n(n,e,t){const r=new K,i=new m(Math.min(n.x,e.x),Math.min(n.y,e.y),Math.min(n.z,e.z)),o=new m(Math.max(n.x,e.x),Math.max(n.y,e.y),Math.max(n.z,e.z)),l=new m(o.x-i.x,0,0),h=new m(0,o.y-i.y,0),s=new m(0,0,o.z-i.z),a=l.clone().multiplyScalar(-1),f=s.clone().multiplyScalar(-1);return r.add(new T(new m(i.x,i.y,o.z),l,h,t)),r.add(new T(new m(o.x,i.y,o.z),f,h,t)),r.add(new T(new m(o.x,i.y,i.z),a,h,t)),r.add(new T(new m(i.x,i.y,i.z),s,h,t)),r.add(new T(new m(i.x,o.y,o.z),l,f,t)),r.add(new T(new m(i.x,i.y,i.z),l,s,t)),r}function Jt(n){switch(n.type){case Et.type:return Et.fromJSON(n);case St.type:return St.fromJSON(n);case T.type:return T.fromJSON(n);case _t.type:return _t.fromJSON(n);case vt.type:return vt.fromJSON(n);case K.type:return K.fromJSON(n);case Pt.type:return Pt.fromJSON(n);default:throw new Error("无效的object类型:"+n.type)}}const Ct=class Ct{toJSON(){return{type:Ct.type}}scatter(e,t){return!1}scattering_pdf(e,t,r){return 0}emitted(e,t,r,i,o){return new v(0,0,0)}};c(Ct,"type","_Material");let G=Ct;const xt=class xt extends G{constructor(t){super();c(this,"tex");t instanceof v?this.tex=new F(t):this.tex=t}load(){return this.tex instanceof bt?this.tex.load():Promise.resolve()}scattering_pdf(t,r,i){const o=r.normal.dot(i.norm_dir);return o<0?0:o/Math.PI}scatter(t,r){const i=new Vt;return i.attenuation=this.tex.value(r.u,r.v,r.p),i.pdf=new Oe(r.normal),i.skip_pdf=!1,i}toJSON(){return{type:xt.type,tex:this.tex.toJSON()}}static fromJSON(t){return z(t.type,xt.type),new xt(yt(t.tex))}};c(xt,"type","_LambertianMaterial");let B=xt;const mt=class mt extends G{constructor(e,t){super(),this.albedo=e,this.fuzz=t}scatter(e,t){const r=ue(e.dir,t.normal).normalize().addScaledVector(he(),this.fuzz),i=new Vt;return i.attenuation=this.albedo,i.pdf=null,i.skip_pdf=!0,i.skip_pdf_ray=new D(t.p,r,e.tm),i}toJSON(){return{type:mt.type,albedo:this.albedo.toJSON(),fuzz:this.fuzz}}static fromJSON(e){return z(e.type,mt.type),new mt(v.fromJSON(e.albedo),e.fuzz)}};c(mt,"type","_MetalMaterial");let $t=mt;const Y=class Y extends G{constructor(e){super(),this.refraction_index=e}scatter(e,t){const r=t.front_face?1/this.refraction_index:this.refraction_index,i=Math.min(-e.norm_dir.dot(t.normal),1),h=Math.sqrt(1-i*i)*r>1||ve(i,r)>Math.random()?ue(e.norm_dir,t.normal):_e(e.norm_dir,t.normal,r),s=new Vt;return s.attenuation=Y.Attenuation,s.pdf=null,s.skip_pdf=!0,s.skip_pdf_ray=new D(t.p,h,e.tm),s}toJSON(){return{type:Y.type,refraction_index:this.refraction_index}}static fromJSON(e){return z(e.type,Y.type),new Y(e.refraction_index)}};c(Y,"type","_DielectricMaterial"),c(Y,"Attenuation",new v(1,1,1));let zt=Y;const pt=class pt extends G{constructor(t){super();c(this,"tex");t instanceof v?this.tex=new F(t):this.tex=t}emitted(t,r,i,o,l){return r.front_face?this.tex.value(i,o,l):new v(0,0,0)}toJSON(){return{type:pt.type,tex:this.tex.toJSON()}}static fromJSON(t){return z(t.type,pt.type),new pt(yt(t.tex))}};c(pt,"type","_DiffuseLightMaterial");let Ot=pt;const Z=class Z extends G{constructor(t){super();c(this,"tex");t instanceof v?this.tex=new F(t):this.tex=t}scattering_pdf(t,r,i){return Z._pdf}scatter(t,r){const i=new Vt;return i.attenuation=this.tex.value(r.u,r.v,r.p),i.pdf=new Ut,i.skip_pdf=!1,i}toJSON(){return{type:Z.type,tex:this.tex.toJSON()}}static fromJSON(t){return z(t.type,Z.type),new Z(yt(t.tex))}};c(Z,"type","_IsotropicMaterial"),c(Z,"_pdf",1/4/Math.PI);let Nt=Z;function me(n){switch(n.type){case G.type:return new G;case B.type:return B.fromJSON(n);case $t.type:return $t.fromJSON(n);case zt.type:return zt.fromJSON(n);case Ot.type:return Ot.fromJSON(n);case Nt.type:return Nt.fromJSON(n);default:throw new Error("错误的material类型:"+n.type)}}function vn(n){return new Worker("https://dengcheke.github.io/ray-tracing-typescript/assets/remote-client-Dx3QDDES.js",{type:"module",name:n==null?void 0:n.name})}const Zt=[],Sn=Math.max(navigator.hardwareConcurrency/2,1);for(let n=0;n<Sn;n++){const e=we(new vn,n);Zt.push(e)}function zn(){const n=new K,e=new B(new v(.65,.05,.05)),t=new B(new v(.73,.73,.73)),r=new B(new v(.12,.45,.15)),i=new Ot(new v(15,15,15));[{Q:new m(555,0,0),u:new m(0,0,555),v:new m(0,555,0),mat:r},{Q:new m(0,0,555),u:new m(0,0,-555),v:new m(0,555,0),mat:e},{Q:new m(0,555,0),u:new m(555,0,0),v:new m(0,0,555),mat:t},{Q:new m(0,0,555),u:new m(555,0,0),v:new m(0,0,-555),mat:t},{Q:new m(555,0,555),u:new m(-555,0,0),v:new m(0,555,0),mat:t},{Q:new m(213,554,227),u:new m(130,0,0),v:new m(0,0,105),mat:i}].forEach(({Q:a,u:f,v:u,mat:d})=>{n.add(new T(a,f,u,d))});const o=_n(new m(0,0,0),new m(165,330,165),t);n.add(new _t(new vt(o,15),new m(265,0,295))),n.add(new St(new m(190,90,190),90,new zt(1.5)));const l=new G,h=new K;return h.add(new T(new m(343,554,332),new m(-130,0,0),new m(0,0,-105),l)),{camera:new Lt({aspect_ratio:1,image_width:600,samples_per_pixel:1e3,max_depth:50,background:new v(0,0,0),vfov:40,lookfrom:new m(278,278,-800),lookat:new m(278,278,0),vup:new m(0,1,0),defocus_angle:0}),world:n,lights:h}}const{world:On,camera:ce,lights:Nn}=zn(),Jn=document.body.querySelector("#info"),Xt=document.body.querySelector("#button"),Rt=Mn();Xt.addEventListener("click",()=>{Rt.running?(Xt.innerHTML="开始",Rt.stop()):(Xt.innerHTML="暂停",Rt.start())});function Mn(){const{image_height:n,image_width:e}=ce,t=document.createElement("canvas"),r=t.getContext("2d");document.body.appendChild(t),t.width=e,t.height=n;const i=e*n;let o=0;const l=50;let h=!1,s=0,a=!1,f;const u=[];return{get running(){return a},start(){if(!a){if(a=!0,!f){const y=On.toJSON(),S=ce.toJSON(),b=Nn.toJSON();f=Promise.all(Zt.map(j=>j.buildScene(y,S,b)))}f.then(()=>{Zt.forEach(y=>d(y))})}},stop(){a&&(a=!1)}};function d(y){if(!a||y._busy||s>=i)return;y._busy=!0;const S=s,b=Math.floor(S/e),j=(b+1)*e,C=s=Math.min(S+l,j),w=[S-b*e,b];y.renderPixels([S,C]).then(g=>{const O=x(g);o+=C-S,p({dxdy:w,imageData:O})}).finally(()=>{y._busy=!1,d(y)})}function x(y){const S=y.length/4,b=r.createImageData(S,1);return b.data.set(y),b}function p(y){u.push(y),!h&&(h=!0,requestAnimationFrame(()=>{Jn.innerHTML=`${o}/${i}`;const S=[...u];u.length=0,S.forEach(b=>{r.putImageData(b.imageData,b.dxdy[0],b.dxdy[1])}),h=!1}))}}
